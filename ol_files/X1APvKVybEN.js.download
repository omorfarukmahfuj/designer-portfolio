;/*FB_PKG_DELIM*/

__d("WABulkSetRotateSenderKeyToTrueApi",["MAWTransactionMode","WADbPersonalSenderKeyStatusTxns","WADbTransactor"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({personalSenderKeyStatuses:d("MAWTransactionMode").READWRITE},"bulkSetRotateSenderKeyToTrue",function(a){return function(b,c){return d("WADbPersonalSenderKeyStatusTxns").bulkSetRotateSenderKeyToTrueTxn(a,c).then(function(){})}});g.bulkSetRotateSenderKeyToTrue=a}),98);
__d("WAAlignChunkLengthsToMultipleOfAesBlockSize",[],(function(a,b,c,d,e,f){"use strict";function g(a){return parseInt((a+15)/16,10)*16}function a(a,b){var c=[],d=0,e=0,f=0;for(var h=0;h<a.length;++h){d+=a[h];if(h===a.length-1&&b!=null&&b>0){d>e?c.push(b-e):(c.pop(),c.push(b-f));break}else if(d>e){var i=g(d-e);f=e;c.push(i);e+=i}}return c}f.alignChunkSizeToMultipleAesBlockSize=g;f.alignChunkLengthsToMultipleOfAesBlockSize=a}),66);
__d("WAProgressiveJpegAlignScanLengths",["WAAlignChunkLengthsToMultipleOfAesBlockSize"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.scanLengths;a=a.totalEncryptedBytes;return d("WAAlignChunkLengthsToMultipleOfAesBlockSize").alignChunkLengthsToMultipleOfAesBlockSize(b.map(function(a){return a}),a).map(function(a){return a})}function b(a){return a}g.progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize=a;g.toProgressiveJpegAlignedScanLength=b}),98);
__d("WAProgressiveJpegGetPJpegDetails",["WAMediaCrypto","WAProgressiveJpegAlignScanLengths","WAProgressiveJpegGetScanLengths","WAResultOrError","WATagsLogger","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar size mismatch"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar is missing"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Progressive Jpeg sidecar has an invalid length"]);j=function(){return a};return a}var k=d("WATagsLogger").TAGS(["WAProgressiveJpegDetails"]);function a(a){var b=a.progressiveJpegDetails;a=a.ciphertextLength;return babelHelpers["extends"]({},b,{alignedScanLengths:d("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:b.scanLengths,totalEncryptedBytes:a})})}function c(a,c,e){var f,g,h,i;return b("regeneratorRuntime").async(function(j){while(1)switch(j.prev=j.next){case 0:f=c.byteLength-d("WAMediaCrypto").IV_LENGTH;g=d("WAProgressiveJpegGetScanLengths").getProgressiveJpegScanLengths(a);h=d("WAProgressiveJpegAlignScanLengths").progressiveJpegAlignChunkLengthsToMultipleOfAesBlockSize({scanLengths:g,totalEncryptedBytes:f});j.next=5;return b("regeneratorRuntime").awrap(l(h,c,e));case 5:i=j.sent;return j.abrupt("return",{scanLengths:g,sidecar:i});case 7:case"end":return j.stop()}},null,this)}function l(a,c,e){var f,g,h,i,j,k,l,m,n;return b("regeneratorRuntime").async(function(o){while(1)switch(o.prev=o.next){case 0:f=new Uint8Array(a.length*10),g=0,h=0,i=c.slice(0,16),j=c.slice(16),k=0;case 6:if(!(k<a.length)){o.next=19;break}l=a[k];h=g+l;m=j.subarray(g,h);o.next=12;return b("regeneratorRuntime").awrap(d("WAMediaCrypto").hmacCiphertext(e,i,m));case 12:n=o.sent.slice(0,10),f.set(new Uint8Array(n),k*10),i=m.slice(m.length-16,m.length),g=h;case 16:k++;o.next=6;break;case 19:return o.abrupt("return",f.buffer);case 20:case"end":return o.stop()}},null,this)}function m(a){if(a.sidecar.byteLength%d("WAMediaCrypto").HMAC_LENGTH!==0){k.ERROR(j());return d("WAResultOrError").makeError("pjpeg-check-sidecar-invalid-length")}if(a.scanLengths.length>0&&a.sidecar.byteLength===0){k.ERROR(i());return d("WAResultOrError").makeError("pjpeg-check-no-sidecar")}if(a.scanLengths.length===0)return d("WAResultOrError").makeResult(!1);if(a.scanLengths.length*d("WAMediaCrypto").HMAC_LENGTH!==a.sidecar.byteLength){k.ERROR(h());return d("WAResultOrError").makeError("pjpeg-check-scan-length-mismatch")}return d("WAResultOrError").makeResult(!0)}function e(a,b){var c=0;if(b===0)return 0;for(var d=0;d<b;d++){var e=a[d];e!=null&&(c+=e)}return c}function f(a){a=a.progressiveJpegDetails;if(a==null)return d("WAResultOrError").makeResult(null);var b=m(a);if(b.success===!1)return b;return b.value===!0?d("WAResultOrError").makeResult({scanLengths:a.scanLengths,sidecar:a.sidecar}):d("WAResultOrError").makeResult(null)}g.getExtendedProgressiveJpegDetails=a;g.getProgressiveJpegDetails=c;g.isValidProgressiveJpegDetails=m;g.getTotalByteSizeForScan=e;g.maybeGetProgressiveJpegDetailsUsingMediaEntry=f}),98);
__d("WADownloadDownloadablePreview",["WADownloadMedia","WAGlobals","WAMediaCrypto","WAProgressiveJpegGetPJpegDetails","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["finished downloading"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["failed to download media. Reason: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - mediaEntryData "," is incomplete for media preview"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["DownloadableThumbnail exists. Attempting to download."]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Skipping downloadablePreview for progressive jpeg"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["No downloadableThumbnail. Skipping..."]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["thumbnail_available: ",""]);o=function(){return a};return a}var p=d("WADownloadMedia").mediaDownloadLogger.TAGS(["DownloadDownloadablePreview"]);function a(a,b,c,d,e,f){return q.apply(this,arguments)}function q(){q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e,f,g){var q=g.getMediaPlaintext,r=g.handleMediaPreviewBeforeDownload;g=g.updateMediaEntryForMsg;var s=e.downloadableThumbnail,t=s==null?void 0:s.directPath,u=t!=null,v=d("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(e);v=v.success===!0?v.value:null;p.LOG(o(),u);if(s==null||t==null){p.LOG(n());return null}if(v!=null&&e.serverMediaType==="image"&&d("WAGlobals").getConfig().skipDownloadablePreviewForProgressiveJpeg()){p.LOG(m());return null}p.LOG(l());u=s.fileEncSha256;var w=s.fileSha256,x=s.mediaKey;s=s.objectId;f=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:a,downloadEntry:f+"-preview",msgType:null});f.addAnnotations({bool:{duplicateDirectPath:t===e.directPath,isMediaFallbackToAlternativeHmacSaltsEnabled:d("WAGlobals").getConfig().isMediaFallbackToAlternativeHmacSaltsEnabled(),isProgressiveJpeg:v!=null},string:{mediaType:"preview",fullSizeMediaType:e.serverMediaType}});f.addPoint("wa_protocol_media_download_start");if(t==null||u==null||w==null||x==null){p.ERROR(k(),e);f.addPoint("wa_protocol_media_download_fail");f.endFail("preview-incomplete-media-entry");return}v=d("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(c);if(v==null){p.ERROR(j(),c);f.addPoint("wa_protocol_media_download_fail");f.endFail("preview-unsupported-type");return}yield r(b);c=(yield d("WADownloadMedia").downloadMediaImpl(a,b,f,{messageType:v,type:"preview"},t,u,w,x,s,null,e,{getMediaPlaintext:q,updateMediaEntryForMsg:g}));if(c.success===!1)p.WARN(i(),c.error),f.addPoint("wa_protocol_media_download_fail"),f.endFail(c.error);else{p.LOG(h());f.addPoint("wa_protocol_media_download_end");f.endSuccess();return c.value}});return q.apply(this,arguments)}g.maybeDownloadDownloadablePreview=a}),98);
__d("WADecryptMedia",["WAGlobals","WAMediaCrypto","WAResultOrError","WATagsLogger","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Success"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using default plaintext verifier"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose([""," is not a working hmac salt."]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Found a working hmac salt using ","."]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Trying "," as an alternative hmac salt."]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Encountered enc-hash-mismatch - looking for a potential working hmac salt"]);n=function(){return a};return a}var o=d("WATagsLogger").TAGS(["WADecryptMedia"]);function p(a,c,e,f){var g,h,i,j,p,q,r,s,t,u,v;return b("regeneratorRuntime").async(function(w){while(1)switch(w.prev=w.next){case 0:o.WARN(n());g=e.type==="preview"?"preview":e.mediaType;w.next=4;return b("regeneratorRuntime").awrap(d("WAMediaCrypto").deprecated_getAllCommonComputedMediaKeys(f));case 4:h=w.sent,(j=h,p=Array.isArray(j),q=0,j=p?j:j[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]());case 6:if(!p){w.next=12;break}if(!(q>=j.length)){w.next=9;break}return w.abrupt("break",39);case 9:r=j[q++];w.next=16;break;case 12:q=j.next();if(!q.done){w.next=15;break}return w.abrupt("break",39);case 15:r=q.value;case 16:s=r;t=s[0];u=s[1];w.prev=19;if(!(t===g)){w.next=22;break}return w.abrupt("continue",37);case 22:o.LOG(m(),t);w.t0=d("WAResultOrError").makeResult;w.next=26;return b("regeneratorRuntime").awrap(d("WAMediaCrypto").hmacAndDecrypt(u.cipherKey,u.iv,a,u.hmacKey,c));case 26:w.t1=w.sent;v=w.t0(w.t1);i={hmacAndDecryptResult:v,alternativeHmacSaltUsed:t};o.LOG(l(),t);return w.abrupt("return",i);case 33:w.prev=33;w.t2=w["catch"](19);o.LOG(k(),t);return w.abrupt("continue",37);case 37:w.next=6;break;case 39:return w.abrupt("return",{hmacAndDecryptResult:d("WAResultOrError").makeError("enc-hash-mismatch")});case 40:case"end":return w.stop()}},null,this,[[19,33]])}function a(a){var c,e,f,g,k,l,m,n,q,r,s,t,u,v;return b("regeneratorRuntime").async(function(w){while(1)switch(w.prev=w.next){case 0:c=a.ciphertextHmac,e=a.mediaKey,f=a.mediaTypeDetails,g=a.plaintextHash;o.LOG(j());k=c.byteLength-d("WAMediaCrypto").HMAC_LENGTH;l=new Uint8Array(c,k);m=new Uint8Array(c,0,k);f.type==="preview"?n=d("WAMediaCrypto").computeMediaKeysForPreview(e):n=d("WAMediaCrypto").computeMediaKeys(e,f.mediaType);r=null;w.next=9;return b("regeneratorRuntime").awrap(n.then(function(a){var b=a.iv,c=a.cipherKey;a=a.hmacKey;return d("WAMediaCrypto").hmacAndDecrypt(c,b,m,a,l)}).then(d("WAResultOrError").makeResult)["catch"](function(a){o.ERROR(i(),a);if(a instanceof d("WAMediaCrypto").HmacValidationError)return d("WAResultOrError").makeError("enc-hash-mismatch");else return d("WAResultOrError").makeError("decryption-error")}));case 9:q=w.sent;if(!(d("WAGlobals").getConfig().isMediaFallbackToAlternativeHmacSaltsEnabled()===!0&&q.success===!1&&q.error==="enc-hash-mismatch")){w.next=16;break}w.next=13;return b("regeneratorRuntime").awrap(p(m,l,f,e));case 13:s=w.sent,q=s.hmacAndDecryptResult,r=s.alternativeHmacSaltUsed;case 16:if(q.success){w.next=18;break}return w.abrupt("return",q);case 18:t=q.value,u=t.plaintext,v=t.plaintextHash;if(!(g!==v)){w.next=21;break}return w.abrupt("return",d("WAResultOrError").makeError("hash-mismatch"));case 21:o.LOG(h());return w.abrupt("return",d("WAResultOrError").makeResult({plaintext:u,alternativeHmacSaltUsed:r}));case 23:case"end":return w.stop()}},null,this)}g.decryptMedia=a}),98);
__d("WADecimalStringMod",["WAErr","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(['"','" is over 64 bits']);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(['"','" is not a valid decimal string']);i=function(){return a};return a}function a(a,b){if(!/^\d+$/.test(a)){d("WALogger").ERROR(i(),a);throw c("WAErr")("decimalStringMod is given an invalid decimal string")}var e=a.length;if(e<16||e===16&&a<="9007199254740991")return Number(a)%b;if(e>20||e===20&&a>"18446744073709551615"){d("WALogger").ERROR(h(),a);throw c("WAErr")("decimalStringMod is given value over 64 bits")}e=0;for(var f=0;f<a.length;f++){var g=Number(a[f]);e=(e*10+g)%b}return e}g.decimalStringMod=a}),98);
__d("WACreateGetVcaEnabledBucket",["WAArrayBufferUtils","WADecimalStringMod","WALogger"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaRouteSelection: can't get fbId from mediaDirectPath"]);h=function(){return a};return a}function a(a,b){return function(){return b==null?null:d("WAArrayBufferUtils").arrayBufferMod(a,b)+100}}function b(a,b){return function(){if(b==null)return null;var c=a.split("/");c=c[c.length-1];c=c.split("_")[1];if(!/^\d+$/.test(c))return null;if(c==null){d("WALogger").ERROR(h());return null}else return d("WADecimalStringMod").decimalStringMod(c,b)+100}}g.createGetVcaEnabledBucket=a;g.msgrCreateGetVcaEnabledBucket=b}),98);
__d("WAExtractNcHotTimestamp",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)return null;a=h(a);if(a.has("_nc_hot")){a=parseInt(a.get("_nc_hot"),10);return Number.isInteger(a)?d("WATimeUtils").castToUnixTime(a):null}else return null}function h(a){a=a.split("?");return new URLSearchParams(a.length===2?a[1]:"")}g.extractNcHotTimestamp=a}),98);
__d("WAMediaConnParser",["WADeprecatedWapParser","WAServerMediaType"],(function(a,b,c,d,e,f,g){"use strict";a=new(c("WADeprecatedWapParser"))("mediaConnParser",function(a){a=a.child("media_conn");var b=j(a);return{hosts:b,authToken:a.attrString("auth"),authTokenExpiryTs:a.attrFutureTime("auth_ttl"),routesExpiryTs:a.attrFutureTime("ttl"),maxBuckets:a.attrInt("max_buckets"),maxManualRetry:(b=a.maybeAttrInt("max_manual_retry",0,4))!=null?b:3,maxAutoDownloadRetry:(b=a.maybeAttrInt("max_auto_download_retry",0,4))!=null?b:3}});function h(a){var b;return!a.hasAttr("fallback_hostname")?void 0:{domain:a.attrString("fallback_hostname"),"class":a.maybeAttrString("fallback_class"),ip4:(b=a.maybeAttrString("fallback_ip4"))!=null?b:void 0,ip6:(b=a.maybeAttrString("fallback_ip6"))!=null?b:void 0}}function i(a){var b;return{domain:a.attrString("hostname"),fallback:h(a),uploadable:k(a,"upload"),downloadable:k(a,"download"),isFallback:a.maybeAttrString("type")==="fallback",downloadBuckets:(b=(b=a.maybeChild("download_buckets"))==null?void 0:b.mapChildren(function(a){return parseInt(a.tag(),10)}))!=null?b:[],"class":a.maybeAttrString("class"),ip4:(b=a.maybeAttrString("ip4"))!=null?b:void 0,ip6:(b=a.maybeAttrString("ip6"))!=null?b:void 0}}function j(a){return a.mapChildrenWithTag("host",i)}function k(a,b){if(a.hasChild(b))return a.child(b).mapChildren(function(a){a=a.tag();return d("WAServerMediaType").castToServerMediaType(a)}).filter(Boolean);else return d("WAServerMediaType").SERVER_MEDIA}g.mediaConnParser=a}),98);
__d("WAGatherMediaInfo",["WADeprecatedSendIq","WAErrors","WALogger","WAMediaConnParser","WAPromiseManagement","WAPromiseRetryLoop","WAResultOrError","WAWap"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo error ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," hosts"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got client error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo got "," seconds backoff"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["gatherMediaInfo failure ",""]);l=function(){return a};return a}var m=507;b=d("WAPromiseManagement").cacheWhilePending(function(){return"gatherMediaInfo"},a);function a(){var a=new(d("WAPromiseRetryLoop").PromiseRetryLoop)({name:"gatherMediaInfo",timer:{jitter:.25,max:987e3,algo:{type:"fibonacci",first:6e3,second:12e3},relativeDelay:!0},code:o});a.start();return a.promise()}var n=60;function o(a){var b;b=(b=d("WAWap")).wap("iq",{to:b.S_WHATSAPP_NET,xmlns:"w:m",type:"set",id:b.generateId()},b.wap("media_conn",null));return d("WADeprecatedSendIq").deprecatedSendIqIfConnectedWithin(b,d("WAMediaConnParser").mediaConnParser,n).then(function(b){if(!b.success){d("WALogger").LOG(l(),b);if(b.errorCode===m){var c=b.errorBackoff;d("WALogger").LOG(k(),c);a(d("WAResultOrError").makeError({type:"backoff",backoffMs:c*1e3}))}else b.errorCode<500&&(d("WALogger").LOG(j(),b.errorCode),a(d("WAResultOrError").makeError({type:"client-error",code:b.errorCode,text:b.errorText})))}else d("WALogger").LOG(i(),b.result.hosts.length),a(d("WAResultOrError").makeResult(b.result))})["catch"](function(b){b instanceof d("WAErrors").Disconnected?a(d("WAResultOrError").makeError("disconnected")):d("WALogger").ERROR(h(),b)})}g.gatherMediaInfo=b}),98);
__d("WAMediaRouteSelection",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=null,c=null,e=null,f=a.hosts,g=a.operation,h=a.mediaType;if(a.operation==="download"){var i=a.catHotTimespan,j=a.ncHot;a=a.getVcaEnabledBucket;var k=new Map();f.forEach(function(a){a.downloadBuckets.forEach(function(b){k.set(b,a)})});var l=k.get(0);i>0&&j!=null&&d("WATimeUtils").happenedWithin(d("WATimeUtils").castToUnixTime(j),i)?b=1:a&&(b=a());j=null;b!=null&&(j=k.get(b));((i=j)==null?void 0:i.downloadable.includes(h))?c=j:(l==null?void 0:l.downloadable.includes(h))&&(c=l)}for(a=0;a<f.length;a++){i=f[a];g==="upload"&&i.uploadable.includes(h)?c==null?c=i:i.isFallback&&e==null&&(e=i):g==="download"&&i.downloadable.includes(h)&&(c==null?c=i:i.isFallback&&e==null&&(e=i));if(c!=null&&e!=null)break}return{selectedHost:c,fallbackHost:e,bucket:b}}g.mediaRouteSelection=a}),98);
__d("WAGetMediaRoute",["$InternalEnum","Promise","WAComms","WACreateGetVcaEnabledBucket","WAExtractNcHotTimestamp","WAGatherMediaInfo","WAGlobals","WAMediaRouteSelection","WAPromiseManagement","WAResultOrError","WATagsLogger","WATimeUtils","WAWorkerGlobalScope","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error occurred on gather after backoff expiry: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Can not get mediaAccess: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, gather a new one"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaAccess has gone, but we are still locked by backoff"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error occurred during authTTL automatic refresh: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["AuthTTL approaching expiry, refreshing MediaAccess routes"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error: no media host"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to get mediaAccess: ",""]);p=function(){return a};return a}var q=d("WATagsLogger").TAGS(["GetMediaRoute"]),r=!0,s=86400,t=b("$InternalEnum")({Fresh:"fresh",Cached:"cached",Stale:"stale"}),u=null,v=!1,w=null;function a(a,c){var e,f,g,h,i,j,k,l,m,n,t;return b("regeneratorRuntime").async(function(u){while(1)switch(u.prev=u.next){case 0:e="get_cached_or_fresh_media_access_start";f="get_cached_or_fresh_media_access_end";c==null?void 0:c.addPoint(e);u.next=5;return b("regeneratorRuntime").awrap(A());case 5:g=u.sent;c==null?void 0:c.addPoint(f);if(g.success){u.next=11;break}q.ERROR(p(),g.error);c==null?void 0:c.addPoint("get_media_access_failed",{string:{mediaAccessStatus:g.error}});return u.abrupt("return",g);case 11:c==null?void 0:c.addAnnotations({string:{mediaAccessStatus:g.value.state}});h=g.value.mediaAccess,i=h.authToken,j=h.hosts,k=h.maxBuckets;l=a.operation==="upload"?d("WAMediaRouteSelection").mediaRouteSelection({operation:"upload",mediaType:a.serverMediaType,hosts:j}):d("WAMediaRouteSelection").mediaRouteSelection({operation:"download",mediaType:a.serverMediaType,hosts:j,catHotTimespan:s,ncHot:d("WAExtractNcHotTimestamp").extractNcHotTimestamp(a.directPath),getVcaEnabledBucket:r?d("WACreateGetVcaEnabledBucket").msgrCreateGetVcaEnabledBucket(a.directPath,k):void 0}),m=l.selectedHost,n=l.fallbackHost,t=l.bucket;if(!(m==null)){u.next=17;break}q.ERROR(o());return u.abrupt("return",d("WAResultOrError").makeError("no-host"));case 17:return u.abrupt("return",d("WAResultOrError").makeResult({authToken:i,selectedHost:m,fallbackHost:n,bucket:t}));case 18:case"end":return u.stop()}},null,this)}function x(){var a=w;a!=null&&(d("WAWorkerGlobalScope").workerGlobalScope.clearTimeout(a),w=null)}function y(a){x();var b=Math.max(a.authTokenExpiryTs-d("WATimeUtils").unixTime(),0);if(b<=5*60)return;var c=d("WATimeUtils").pastUnixTime(5*60,a.authTokenExpiryTs);b=d("WATimeUtils").pastUnixTime(Math.floor(b*.2),a.authTokenExpiryTs);a=c<b?c:b;c=d("WATimeUtils").cappedMillisecondsUntil(a);b=Math.floor(Math.random()*d("WATimeUtils").MINUTE_MILLISECONDS);a=d("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){q.LOG(n()),z()["catch"](function(a){q.ERROR(m(),a)})},c+b);w=a}var z=d("WAPromiseManagement").cacheWhilePending(function(){return"all"},function(){var a,c,e;return b("regeneratorRuntime").async(function(f){while(1)switch(f.prev=f.next){case 0:if(!v){f.next=3;break}q.LOG(l());return f.abrupt("return",d("WAResultOrError").makeError("backoff"));case 3:if(!d("WAGlobals").getConfig().shouldWaitForConnection()){f.next=6;break}f.next=6;return b("regeneratorRuntime").awrap(d("WAComms").waitForConnection());case 6:q.LOG(k());x();f.next=10;return b("regeneratorRuntime").awrap(d("WAGatherMediaInfo").gatherMediaInfo());case 10:a=f.sent;if(!a.success){f.next=17;break}u=a.value;y(a.value);return f.abrupt("return",d("WAResultOrError").makeResult({mediaAccess:a.value,state:t.Fresh}));case 17:c=a.error;e=c==="disconnected"?"disconnected":c.type;q.WARN(j(),e);if(!(c==="disconnected"||c.type==="client-error")){f.next=24;break}return f.abrupt("return",d("WAResultOrError").makeError("disconnected"));case 24:c.type;v=!0;d("WAWorkerGlobalScope").workerGlobalScope.setTimeout(function(){v=!1,z()["catch"](function(a){q.ERROR(i(),a)})},c.backoffMs);return f.abrupt("return",d("WAResultOrError").makeError("backoff"));case 28:case"end":return f.stop()}},null,this)}),A=function(){var a=u;if(a==null)return z();if(d("WATimeUtils").isInFuture(a.routesExpiryTs))return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult({mediaAccess:a,state:t.Cached}));var c=z();return d("WATimeUtils").isInFuture(a.authTokenExpiryTs)?(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult({mediaAccess:a,state:t.Stale})):c};function c(){u=null,v=!1,x()}g.getMediaRoute=a;g.clearCachedMediaAccessForTest=c}),98);
__d("WAMediaOperationsRetrier",["WALogger","WAPromiseBackoffs","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["MediaOperationsRetrier:"," wait for internet, attempt = ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Running retrier"]);i=function(){return a};return a}var j=4,k={algo:{type:"constant",delay:1e3},jitter:0};a=function(){function a(a,b,c){this.$1=a,this.routesInfo=b,this.$2=d("WAPromiseBackoffs").createPromiseTimer(k),this.$3=0,this.$4=!1,this.$5=c}var c=a.prototype;c.run=function(a,c){var e,f,g,k;return b("regeneratorRuntime").async(function(l){while(1)switch(l.prev=l.next){case 0:if(!(this.$3<j)){l.next=29;break}d("WALogger").DEV(i());l.next=4;return b("regeneratorRuntime").awrap(this.$2());case 4:e=void 0;if(!(this.$3>0)){l.next=12;break}e=this.$3>=j-2&&!this.$4;d("WALogger").LOG(h(),this.$1,this.$3);l.next=10;return b("regeneratorRuntime").awrap(this.$5==null?void 0:this.$5());case 10:l.next=13;break;case 12:e=!1;case 13:f=this.routesInfo;if(f){l.next=16;break}return l.abrupt("return",null);case 16:g=f.host;e&&f.fallbackHost&&(g=f.fallbackHost);l.next=20;return b("regeneratorRuntime").awrap(a(g,f.authToken,this.$3,c));case 20:k=l.sent;if(!k.success){l.next=25;break}return l.abrupt("return",k.value);case 25:++this.$3,this.$4=k.error.progressMade;case 27:l.next=0;break;case 29:return l.abrupt("return",null);case 30:case"end":return l.stop()}},null,this)};return a}();g.MAX_ATTEMPTS=j;g.BACKOFF_OPTIONS=k;g.MediaOperationsRetrier=a}),98);
__d("WACreateMediaDownloadRetrier",["WAComms","WAGetMediaRoute","WAMediaOperationsRetrier","WAResultOrError","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var c,e,f,g,h,i,j,k,l,m,n;return b("regeneratorRuntime").async(function(o){while(1)switch(o.prev=o.next){case 0:c=a.directPath,e=a.eventFlow,f=a.fileEncSha256,g=a.mediaTypeDetails;h=g.type==="regular"?g.mediaType:"preview";e==null?void 0:e.addPoint("get_media_route_start");o.next=5;return b("regeneratorRuntime").awrap(d("WAGetMediaRoute").getMediaRoute({operation:"download",serverMediaType:h,fileEncSha256:f,directPath:c},e));case 5:i=o.sent;e==null?void 0:e.addPoint("get_media_route_finish");if(i.success){o.next=9;break}return o.abrupt("return",i);case 9:j=i.value,k=j.selectedHost,l=j.fallbackHost,m=j.authToken;n=new(d("WAMediaOperationsRetrier").MediaOperationsRetrier)("download",{host:{domain:k.domain,"class":k["class"]},fallbackHost:l&&{domain:l.domain,"class":l["class"]},authToken:m,timeElapsed:null},d("WAComms").waitForConnection);return o.abrupt("return",d("WAResultOrError").makeResult({retrier:n,mediaRouteDetails:i.value}));case 12:case"end":return o.stop()}},null,this)}g.createMediaDownloadRetrier=a}),98);
__d("WASmaxInMmsdIQErrorResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","error");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQErrorResponseMixin=a}),98);
__d("WASmaxInMmsdEnums",[],(function(a,b,c,d,e,f){a={0:"0",1:"1"};b={400:"400",401:"401",404:"404",408:"408",409:"409",415:"415",426:"426",429:"429"};c={500:"500",501:"501",502:"502",503:"503",507:"507"};d={fallback:"fallback",primary:"primary"};e={"false":"false","true":"true"};var g={fna:"fna",pop:"pop"};f.ENUM_0_1=a;f.ENUM_400_401_404_408_409_415_426_429=b;f.ENUM_500_501_502_503_507=c;f.ENUM_FALLBACK_PRIMARY=d;f.ENUM_FALSE_TRUE=e;f.ENUM_FNA_POP=g}),66);
__d("WASmaxInMmsdRequestErrorMixin",["WAResultOrError","WASmaxInMmsdEnums","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").attrString(a,"text");if(!b.success)return b;var c=d("WASmaxParseUtils").attrStringEnum(a,"code",d("WASmaxInMmsdEnums").ENUM_400_401_404_408_409_415_426_429);if(!c.success)return c;a=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,a,"backoff",0,10800);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:c.value,backoff:a.value})}g.parseRequestErrorMixin=a}),98);
__d("WASmaxInMmsdResignCdnUrlResponseClientError",["WAResultOrError","WASmaxInMmsdIQErrorResponseMixin","WASmaxInMmsdRequestErrorMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;c=d("WASmaxInMmsdRequestErrorMixin").parseRequestErrorMixin(c.value);if(!c.success)return c;a=d("WASmaxInMmsdIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({errorRequestErrorMixin:c.value},a.value))}g.parseResignCdnUrlResponseClientError=a}),98);
__d("WASmaxInMmsdServerErrorMixin",["WAResultOrError","WASmaxInMmsdEnums","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").attrString(a,"text");if(!b.success)return b;var c=d("WASmaxParseUtils").attrStringEnum(a,"code",d("WASmaxInMmsdEnums").ENUM_500_501_502_503_507);if(!c.success)return c;a=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,a,"backoff",0,10800);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:c.value,backoff:a.value})}g.parseServerErrorMixin=a}),98);
__d("WASmaxInMmsdResignCdnUrlResponseServerError",["WAResultOrError","WASmaxInMmsdIQErrorResponseMixin","WASmaxInMmsdServerErrorMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;c=d("WASmaxInMmsdServerErrorMixin").parseServerErrorMixin(c.value);if(!c.success)return c;a=d("WASmaxInMmsdIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({errorServerErrorMixin:c.value},a.value))}g.parseResignCdnUrlResponseServerError=a}),98);
__d("WASmaxInMmsdIQResultResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","result");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQResultResponseMixin=a}),98);
__d("WASmaxInMmsdResignCdnUrlResponseSuccess",["WAResultOrError","WASmaxInMmsdIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"cdn_url_resign");if(!c.success)return c;c=d("WASmaxParseUtils").attrString(c.value,"direct_path");if(!c.success)return c;a=d("WASmaxInMmsdIQResultResponseMixin").parseIQResultResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({cdnUrlResignDirectPath:c.value},a.value))}g.parseResignCdnUrlResponseSuccess=a}),98);
__d("WASmaxOutMmsdBaseIQGetRequestMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(){var a=d("WASmaxJsx").smax("iq",{id:d("WAWap").generateId(),type:"get"});return a}function a(a){var b=h();return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeBaseIQGetRequestMixin=a}),98);
__d("WASmaxOutMmsdIQRequestCommonMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(){var a=d("WASmaxJsx").smax("iq",{xmlns:"w:m",to:d("WAWap").S_WHATSAPP_NET});return a}function a(a){var b=h();return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeIQRequestCommonMixin=a}),98);
__d("WASmaxOutMmsdResignCdnUrlResignWithHandleParamsMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(a){a=a.cdnUrlResignHandle;a=d("WASmaxJsx").smax("cdn_url_resign",{handle:d("WAWap").CUSTOM_STRING(a),use_case_hint:"wa_stickers"});return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeResignCdnUrlResignWithHandleParamsMixin=a}),98);
__d("WASmaxOutMmsdResignCdnUrlResignWithObjectIdAndFBIdParamsMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(a){var b=a.cdnUrlResignFbid;a=a.cdnUrlResignObjectId;b=d("WASmaxJsx").smax("cdn_url_resign",{fbid:d("WAWap").CUSTOM_STRING(b),object_id:d("WAWap").CUSTOM_STRING(a),use_case_hint:"fb_encrypted_backup"});return b}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeResignCdnUrlResignWithObjectIdAndFBIdParamsMixin=a}),98);
__d("WASmaxOutMmsdResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup",["WASmaxMixinGroupExhaustiveError","WASmaxOutMmsdResignCdnUrlResignWithHandleParamsMixin","WASmaxOutMmsdResignCdnUrlResignWithObjectIdAndFBIdParamsMixin"],(function(a,b,c,d,e,f,g){function a(a,b){if(b.resignCdnUrlResignWithObjectIdAndFBIdParams)return d("WASmaxOutMmsdResignCdnUrlResignWithObjectIdAndFBIdParamsMixin").mergeResignCdnUrlResignWithObjectIdAndFBIdParamsMixin(a,b.resignCdnUrlResignWithObjectIdAndFBIdParams);if(b.resignCdnUrlResignWithHandleParams)return d("WASmaxOutMmsdResignCdnUrlResignWithHandleParamsMixin").mergeResignCdnUrlResignWithHandleParamsMixin(a,b.resignCdnUrlResignWithHandleParams);throw new(d("WASmaxMixinGroupExhaustiveError").SmaxMixinGroupExhaustiveError)()}g.mergeResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup=a}),98);
__d("WASmaxOutMmsdResignCdnUrlResignParamsMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutMmsdResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup"],(function(a,b,c,d,e,f,g){function h(a){a=a.resignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroupArgs;a=d("WASmaxOutMmsdResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup").mergeResignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroup(d("WASmaxJsx").smax("cdn_url_resign",null),a);return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeResignCdnUrlResignParamsMixin=a}),98);
__d("WASmaxOutMmsdResignCdnUrlRequest",["WASmaxJsx","WASmaxOutMmsdBaseIQGetRequestMixin","WASmaxOutMmsdIQRequestCommonMixin","WASmaxOutMmsdResignCdnUrlResignParamsMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(a){var b=a.cdnUrlResignSignDuration;a=a.resignCdnUrlResignParamsMixinArgs;b=d("WASmaxOutMmsdIQRequestCommonMixin").mergeIQRequestCommonMixin(d("WASmaxOutMmsdBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(d("WASmaxJsx").smax("iq",null,d("WASmaxOutMmsdResignCdnUrlResignParamsMixin").mergeResignCdnUrlResignParamsMixin(d("WASmaxJsx").smax("cdn_url_resign",{sign_duration:d("WAWap").INT(b)}),a))));return b}g.makeResignCdnUrlRequest=a}),98);
__d("WASmaxMmsdResignCdnUrlRPC",["WAComms","WASmaxInMmsdResignCdnUrlResponseClientError","WASmaxInMmsdResignCdnUrlResponseServerError","WASmaxInMmsdResignCdnUrlResponseSuccess","WASmaxOutMmsdResignCdnUrlRequest","WASmaxParsingFailure","WASmaxRpcUtils","regeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a,c){var e,f,g,h,i;return b("regeneratorRuntime").async(function(j){while(1)switch(j.prev=j.next){case 0:e=d("WASmaxOutMmsdResignCdnUrlRequest").makeResignCdnUrlRequest(a);j.next=3;return b("regeneratorRuntime").awrap(d("WAComms").sendSmaxStanza(e,c));case 3:f=j.sent;g=d("WASmaxInMmsdResignCdnUrlResponseSuccess").parseResignCdnUrlResponseSuccess(f,e);if(!g.success){j.next=7;break}return j.abrupt("return",{name:"ResignCdnUrlResponseSuccess",value:g.value});case 7:h=d("WASmaxInMmsdResignCdnUrlResponseClientError").parseResignCdnUrlResponseClientError(f,e);if(!h.success){j.next=10;break}return j.abrupt("return",{name:"ResignCdnUrlResponseClientError",value:h.value});case 10:i=d("WASmaxInMmsdResignCdnUrlResponseServerError").parseResignCdnUrlResponseServerError(f,e);if(!i.success){j.next=13;break}return j.abrupt("return",{name:"ResignCdnUrlResponseServerError",value:i.value});case 13:throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("ResignCdnUrl",{Success:g,ClientError:h,ServerError:i}));case 14:case"end":return j.stop()}},null,this)}g.sendResignCdnUrlRPC=a}),98);
__d("WAGetResignedCdnUrl",["WAAssertUnreachable","WAErrorMessage","WALogger","WAMediaUtils","WAPromiseRetryLoop","WAResultOrError","WASmaxMmsdResignCdnUrlRPC","WASmaxParsingFailure"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["requestCdnResignedUrl - Unknown Error ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["requestCdnResignedUrl - Error thrown whilst parsing SMAX response - ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Direct path signature expired. objectId: ",", fbid: ","."]);j=function(){return a};return a}var k="507",l=259200;function a(a){var b=a.objectId;a=a.fbid;b=new(d("WAPromiseRetryLoop").PromiseRetryLoop)({name:"requestCdnResignedUrl",timer:{jitter:.25,max:987e3,algo:{type:"fibonacci",first:6e3,second:12e3},relativeDelay:!0},code:m({objectId:b,fbid:a})});b.start();return b.promise()}function m(a){var b=a.objectId,e=a.fbid;return function(a){d("WALogger").LOG(j(),b,e);return d("WASmaxMmsdResignCdnUrlRPC").sendResignCdnUrlRPC({cdnUrlResignSignDuration:l,resignCdnUrlResignParamsMixinArgs:{resignWithResignCdnUrlObjectIdAndFBIdOrResignCdnUrlHandleParamsMixinGroupArgs:{resignCdnUrlResignWithObjectIdAndFBIdParams:{cdnUrlResignFbid:e,cdnUrlResignObjectId:b}}}}).then(function(b){switch(b.name){case"ResignCdnUrlResponseSuccess":return a(d("WAResultOrError").makeResult(d("WAMediaUtils").castToDirectPath(b.value.cdnUrlResignDirectPath)));case"ResignCdnUrlResponseClientError":return a(d("WAResultOrError").makeError({type:"client-error",text:b.value.errorRequestErrorMixin.text}));case"ResignCdnUrlResponseServerError":if(b.value.errorServerErrorMixin.code!==k)return;return a(d("WAResultOrError").makeError({type:"server-error",text:b.value.errorServerErrorMixin.text,backoff:b.value.errorServerErrorMixin.backoff}));default:throw c("WAAssertUnreachable")(b.name)}})["catch"](function(b){var c=d("WAErrorMessage").maybeGetMessageFromError(b);if(b instanceof d("WASmaxParsingFailure").SmaxParsingFailure){d("WALogger").ERROR(i(),c);return a(d("WAResultOrError").makeError({type:"smax-parsing-error"}))}else{d("WALogger").ERROR(h(),c);return}})}}g.getCdnResignedUrl=a}),98);
__d("WAHttpDownloadMedia",["WAErrorMessage","WAGlobals","WALogger","WAMediaQplHelper","WAResultOrError","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: can not resume from offset"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetch Media HTTP status ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to initiate fetch: ",", message: ",""]);k=function(){return a};return a}var l="URL signature expired";function a(a,c){var e,f,g,m,n,o,p,q;return b("regeneratorRuntime").async(function(r){while(1)switch(r.prev=r.next){case 0:f=(e=c)!=null?e:{},g=f.mediaMetrics,m=f.abortSignal;g==null?void 0:g.addPoint("http_fetch_start");r.next=4;return b("regeneratorRuntime").awrap(self.fetch(a,{method:"GET",mode:"cors",cache:d("WAGlobals").getConfig().isHttpFetchCacheEnabled()?"force-cache":"no-store",signal:m}).then(function(a){g==null?void 0:g.addPoint("http_fetch_end");return d("WAResultOrError").makeResult(a)})["catch"](function(a){var b=d("WAErrorMessage").maybeGetMessageFromError(a);g==null?void 0:g.addPoint("http_fetch_fail",{string:{httpFetchError:b}});d("WALogger").WARN(k(),a,b);return d("WAResultOrError").makeError("http-fetch-exception")}));case 4:n=r.sent;if(!(n.success===!1)){r.next=7;break}return r.abrupt("return",n);case 7:o=n.value;p=o.headers.get("content-length");q=o.status;d("WALogger").LOG(j(),q);g==null?void 0:g.addAnnotations({string:{ciphertextMediaSizeBucket:p!=null?d("WAMediaQplHelper").convertIntegerSizeToStringBucket(Number(p)):null},"int":{httpStatus:q}});r.t0=q;r.next=r.t0===200?15:r.t0===206?15:r.t0===401?16:r.t0===403?17:r.t0===404?18:r.t0===410?18:r.t0===408?19:r.t0===416?20:r.t0===429?22:r.t0===507?22:23;break;case 15:return r.abrupt("return",d("WAResultOrError").makeResult(o));case 16:return r.abrupt("return",d("WAResultOrError").makeError("access-expired"));case 17:return r.abrupt("return",o.text().then(function(a){return a===l?d("WAResultOrError").makeError("signature-expired"):d("WAResultOrError").makeError("access-expired")})["catch"](function(a){d("WALogger").ERROR(i(),a);return d("WAResultOrError").makeError("access-expired")}));case 18:return r.abrupt("return",d("WAResultOrError").makeError("media-not-found"));case 19:return r.abrupt("return",d("WAResultOrError").makeError("server-timeout"));case 20:d("WALogger").ERROR(h());return r.abrupt("return",d("WAResultOrError").makeError("request-error"));case 22:return r.abrupt("return",d("WAResultOrError").makeError("download-throttled"));case 23:if(!(q>=400&&q<500)){r.next=25;break}return r.abrupt("return",d("WAResultOrError").makeError("request-error"));case 25:return r.abrupt("return",d("WAResultOrError").makeError("unspecified-http-error"));case 26:case"end":return r.stop()}},null,this)}g.httpDownloadMedia=a}),98);
__d("WAHttpUtils",["WAErr"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b,d){if(!/^https:\/\/[-\w.]+\.\w+$/.test(a))throw c("WAErr")('buildUrl given invalid host "'+a+'"');if(!b.startsWith("/"))throw c("WAErr")('buildUrl given invalid path "'+b+'"');var e=d;d=""+a+b;if(!e)return d;a=Object.keys(e).map(function(a){var b=e[a];b instanceof ArrayBuffer&&(b=new Uint8Array(b));b=b instanceof Uint8Array?Array.prototype.slice.call(b).map(function(a){return"%"+a.toString(16)}).join(""):encodeURIComponent(b.toString());return encodeURIComponent(a)+"="+b});if(a.length>0){b=a.join("&");return d.includes("?")?d+"&"+b:d+"?"+b}else return d}g.buildUrl=a}),98);
__d("WAMediaUrl",["WABase64","WAGlobals","WAHttpUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=1;function a(a,b,c,e,f,g,i){var j=d("WAGlobals").getDependencies().mediaUploadRoot();c=d("WABase64").encodeB64UrlSafe(c);b=d("WABase64").encodeB64UrlSafe(b);f={auth:f,token:b};g&&(f.resume=h);i!=null&&i>0&&(f.bytestart=i);return d("WAHttpUtils").buildUrl("https://"+e,j+"/"+a+"/"+c,f)}function b(a,b,c,e,f,g,h){b=d("WABase64").encodeB64UrlSafe(b);b={hash:b,mode:e};f!=null&&(b._nc_cat=f);g!=null&&g>=0&&(b.bytestart=g);h!=null&&h>0&&(b.byteend=h);return d("WAHttpUtils").buildUrl("https://"+c,a,b)}g.RESUME_PARAM=h;g.buildUploadUrl=a;g.buildDownloadUrl=b}),98);
__d("WADownloadCiphertext",["WAAssertUnreachable","WABase64","WACreateMediaDownloadRetrier","WACryptoSha256","WACryptoUtils","WAGetResignedCdnUrl","WAHashUtils","WAHttpDownloadMedia","WALogger","WAMediaUrl","WAPromiseDelays","WAPromiseManagement","WAResultOrError","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext failed: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia given up"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadCiphertext http download exception: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["result to generate a new cdn url was throttled (507)"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Cannot generate a new cdn url: missing objectId or fbid"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Media Error: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpDownloadMedia: fail to parse request body ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Downloading ciphertext for hash : "," from ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Start download ciphertext for hash: ",""]);p=function(){return a};return a}function a(a){var e,f,g,r,s,t,u,v,w,x,y,z,A,B,C,D,E;return b("regeneratorRuntime").async(function(F){while(1)switch(F.prev=F.next){case 0:e=a.mediaTypeDetails,f=a.fileEncSha256,g=a.directPath,r=a.plaintextHash,s=a.objectId,t=a.fbid,u=a.pathRedirected,v=a.eventFlow,w=a.fromBytes,x=a.toBytes;d("WALogger").LOG(p(),d("WAHashUtils").sanitisePlaintextHash(r));F.next=4;return b("regeneratorRuntime").awrap(d("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({mediaTypeDetails:e,directPath:g,eventFlow:v,fileEncSha256:f}));case 4:y=F.sent;if(y.success){F.next=7;break}return F.abrupt("return",y);case 7:z=y.value,A=z.retrier,B=z.mediaRouteDetails;F.next=10;return b("regeneratorRuntime").awrap(A.run(function(a){a=a.domain;a=d("WAMediaUrl").buildDownloadUrl(g,f,a,"manual",B.bucket,w,x);d("WALogger").DEV_XMPP(o(),d("WAHashUtils").sanitisePlaintextHash(r),a);v==null?void 0:v.addPoint("http_download_media_start");return d("WAHttpDownloadMedia").httpDownloadMedia(a,{mediaMetrics:v}).then(function(c){var a,e,f,g;return b("regeneratorRuntime").async(function(h){while(1)switch(h.prev=h.next){case 0:if(!c.success){h.next=4;break}return h.abrupt("return",c.value.arrayBuffer().then(function(a){v==null?void 0:v.addPoint("http_download_media_end");return d("WAResultOrError").makeResult(d("WAResultOrError").makeResult(a))})["catch"](function(a){v==null?void 0:v.addPoint("response_array_buffer_error");d("WALogger").ERROR(n(),a);return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("body-network-error"))}));case 4:v==null?void 0:v.addPoint("http_download_media_fail");a=c.error;d("WALogger").LOG(m(),a);h.t0=a;h.next=h.t0==="signature-expired"?10:h.t0==="http-fetch-exception"?37:h.t0==="server-timeout"?37:h.t0==="unspecified-http-error"?37:38;break;case 10:if(!(s==null||t==null)){h.next=13;break}d("WALogger").LOG(l());return h.abrupt("return",d("WAResultOrError").makeResult(d("WAResultOrError").makeError("signature-expired-and-resign-failed-no-ids")));case 13:h.next=15;return b("regeneratorRuntime").awrap(d("WAGetResignedCdnUrl").getCdnResignedUrl({objectId:s,fbid:t}));case 15:e=h.sent;if(e.success){h.next=31;break}v==null?void 0:v.addPoint("resign_cdn_url_fail",{string:{resignCdnErrorType:e.error.type,resignCdnError:e.error.text}});f=d("WAResultOrError").makeResult(d("WAResultOrError").makeError("signature-expired-and-resign-failed-cdn-url"));h.t1=e.error.type;h.next=h.t1==="client-error"?22:h.t1==="server-error"?23:29;break;case 22:return h.abrupt("return",f);case 23:if(!(e.error.backoff!=null)){h.next=28;break}g=e.error.backoff;v==null?void 0:v.addPoint("resign_cdn_url_backoff");d("WALogger").LOG(k());return h.abrupt("return",d("WAPromiseDelays").delayMs(g).then(function(){return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("signature-expired"))}));case 28:return h.abrupt("return",f);case 29:e.error.type;return h.abrupt("return",f);case 31:e.success;v==null?void 0:v.addPoint("resign_cdn_url_success");if(!(u!=null)){h.next=36;break}h.next=36;return b("regeneratorRuntime").awrap(u(e.value));case 36:return h.abrupt("return",d("WAResultOrError").makeResult(d("WAResultOrError").makeError("signature-expired")));case 37:return h.abrupt("return",d("WAResultOrError").makeError({progressMade:!0}));case 38:return h.abrupt("return",d("WAResultOrError").makeResult(d("WAResultOrError").makeError(a)));case 39:case"end":return h.stop()}},null,this)})["catch"](function(a){d("WALogger").WARN(j(),a);return d("WAResultOrError").makeError({progressMade:!1})})}));case 10:C=F.sent;if(!(C==null)){F.next=14;break}d("WALogger").WARN(i());return F.abrupt("return",d("WAResultOrError").makeError("max-attempts-exceeded"));case 14:if(!(C.success===!1)){F.next=27;break}D=C.error;d("WALogger").WARN(h(),D);F.t0=D;F.next=F.t0==="signature-expired"?20:F.t0==="signature-expired-and-resign-failed-cdn-url"?20:F.t0==="signature-expired-and-resign-failed-no-ids"?20:F.t0==="media-not-found"?20:F.t0==="download-throttled"?20:F.t0==="request-error"?20:F.t0==="access-expired"?21:F.t0==="body-network-error"?22:23;break;case 20:return F.abrupt("return",d("WAResultOrError").makeError(D));case 21:return F.abrupt("return",d("WAResultOrError").makeError("disconnected"));case 22:return F.abrupt("return",d("WAResultOrError").makeError("request-error"));case 23:D;throw c("WAAssertUnreachable")(D);case 25:F.next=40;break;case 27:E=C.value;F.t1=!q(w,x);if(!F.t1){F.next=36;break}F.t2=d("WACryptoUtils").arrayBuffersEqual;F.next=33;return b("regeneratorRuntime").awrap(d("WACryptoSha256").sha256(E));case 33:F.t3=F.sent,F.t4=f,F.t1=!F.t2(F.t3,F.t4);case 36:if(!F.t1){F.next=38;break}return F.abrupt("return",d("WAResultOrError").makeError("ciphertext-hash-mismatch"));case 38:v==null?void 0:v.addPoint("download_finish",{"int":{byteLength:E.byteLength},bool:{isPartialDownload:q(w,x)}});return F.abrupt("return",d("WAResultOrError").makeResult(E));case 40:case"end":return F.stop()}},null,this)}e=d("WAPromiseManagement").cacheWhilePending(function(a){var b=a.fileEncSha256,c=a.fromBytes;a=a.toBytes;return d("WABase64").encodeB64UrlSafe(b)+"-"+((b=c)!=null?b:"X")+"-"+((c=a)!=null?c:"X")},a);function q(a,b){return a!=null&&a>0?!0:b!=null}g.cachedDownloadCiphertext=e}),98);
__d("WADownloadAndDecryptMedia",["WADecryptMedia","WADownloadCiphertext","WAResultOrError","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var c,e,f,g,h,i,j,k,l,m,n;return b("regeneratorRuntime").async(function(o){while(1)switch(o.prev=o.next){case 0:c=a.mediaTypeDetails,e=a.fileEncSha256,f=a.directPath,g=a.mediaKey,h=a.plaintextHash,i=a.objectId,j=a.fbid,k=a.pathRedirected,l=a.eventFlow;o.next=3;return b("regeneratorRuntime").awrap(d("WADownloadCiphertext").cachedDownloadCiphertext({mediaTypeDetails:c,fileEncSha256:e,directPath:f,objectId:i,fbid:j,pathRedirected:k,eventFlow:l,plaintextHash:h}));case 3:m=o.sent;if(!(m.success!==!0)){o.next=6;break}return o.abrupt("return",m);case 6:o.next=8;return b("regeneratorRuntime").awrap(d("WADecryptMedia").decryptMedia({mediaKey:g,mediaTypeDetails:c,plaintextHash:h,ciphertextHmac:m.value}));case 8:n=o.sent;if(!(n.success!==!0)){o.next=11;break}return o.abrupt("return",n);case 11:n.value.alternativeHmacSaltUsed!=null&&l.addAnnotations({string:{alternativeHmacSaltUsed:n.value.alternativeHmacSaltUsed}});return o.abrupt("return",d("WAResultOrError").makeResult(n.value.plaintext));case 13:case"end":return o.stop()}},null,this)}g.downloadAndDecryptMedia=a}),98);
__d("WACreateMediaDecrypterStream",["WABinary","WAErr","WAMediaCrypto","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Invalid PKCS padding length"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Plaintext size is less than CBC_BLOCK_SIZE"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unexpected ciphertext in buffer following flush"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Unable to decrypt chunk: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," of size ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs and ciphertextLengths must have the same length"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["expectedHmacs must have at least one element"]);n=function(){return a};return a}var o=d("WATagsLogger").TAGS(["WADecryptStream"]);function a(a,c,e,f,g){if(f.byteLength===0){o.ERROR(n());return d("WAResultOrError").makeError("missing-expected-hmacs")}if(f.byteLength!==g.length*d("WAMediaCrypto").HMAC_LENGTH){o.ERROR(m());return d("WAResultOrError").makeError("hmac-chiphertext-array-mismatch")}var h=p(f),i=c,r=new(d("WABinary").Binary)(),s=0,t=function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b,c){r.writeByteArray(b);for(;s<h.length&&r.size()>=g[s];s++){b=r.readByteArray(g[s]);o.DEV(l(),s,b.length);try{b=(yield d("WAMediaCrypto").hmacAndDecryptPartial(a,i,b,e,h[s]));var f=b.plaintext;b=b.nextIv;var j=s===g.length-1;j?void c.enqueue(q(f)):void c.enqueue(f);i=b}catch(a){o.ERROR(k(),a),a instanceof d("WAMediaCrypto").HmacValidationError?c.error("enc-hash-mismatch"):c.error("decryption-error")}}});return function(a,b){return c.apply(this,arguments)}}();f=new TransformStream({transform:function(a,b){a=a;return t(a,b)},flush:function(a){r.size()>0&&o.ERROR(j())}});return d("WAResultOrError").makeResult(f)}function p(a){var b=[];if(a.byteLength%d("WAMediaCrypto").HMAC_LENGTH!==0)throw c("WAErr")("Sidecar length is not a multiple of hmac length");for(var e=0;e<a.byteLength;e+=d("WAMediaCrypto").HMAC_LENGTH){var f=new Uint8Array(a,e,d("WAMediaCrypto").HMAC_LENGTH);b.push(f)}return b}function q(a){if(a.length<d("WAMediaCrypto").CBC_BLOCK_SIZE){o.ERROR(i());return a}var b=a[a.length-1];if(b===0||b>d("WAMediaCrypto").CBC_BLOCK_SIZE){o.ERROR(h());return a}return a.subarray(0,-b)}g.createDefaultDecryptStream=a}),98);
__d("WAMediaProgressiveJpegTransformStream",["WABinary"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=a.scanLengths,c=[];a=0;for(var e=b,f=Array.isArray(e),g=0,e=f?e:e[typeof Symbol==="function"?Symbol.iterator:"@@iterator"]();;){var h;if(f){if(g>=e.length)break;h=e[g++]}else{g=e.next();if(g.done)break;h=g.value}h=h;a+=h;c.push(a)}var i=new(d("WABinary").Binary)(),j=0,k=0;h=new TransformStream({transform:function(a,d){a=a;k+=a.byteLength;i.writeByteArray(a);for(;j<b.length&&c[j]<k;j++){a=i.readByteArray(b[j]);void d.enqueue(a)}},flush:function(a){void a.enqueue(i.readByteArray())}});return h}g.makeProgressiveJpegHandlerTransformStream=a}),98);
__d("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry",["WACreateMediaDecrypterStream","WAHttpDownloadMedia","WAMediaCrypto","WAMediaProgressiveJpegTransformStream","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is not a number"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Content-Length header is missing"]);i=function(){return a};return a}var j=d("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);function a(a){return k.apply(this,arguments)}function k(){k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.serverMediaType,c=a.downloadUrl,e=a.eventFlow,f=a.progressiveJpegDetails;a=a.mediaKey;c=(yield d("WAHttpDownloadMedia").httpDownloadMedia(c,{mediaMetrics:e}));if(c.success!==!0)return c;e=c.value.body;if(e==null)return d("WAResultOrError").makeError("body-network-error");c=c.value.headers.get("Content-Length");if(c==null){j.ERROR(i());return d("WAResultOrError").makeError("missing-content-length-header")}c=Number(c);if(Number.isNaN(c)){j.ERROR(h());return d("WAResultOrError").makeError("invalid-content-length-header")}f=d("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:f,ciphertextLength:c});c=(yield d("WAMediaCrypto").computeMediaKeys(a,b));a=d("WACreateMediaDecrypterStream").createDefaultDecryptStream(c.cipherKey,c.iv,c.hmacKey,f.sidecar,f.alignedScanLengths);if(a.success!==!0)return a;b=a.value;c=d("WAMediaProgressiveJpegTransformStream").makeProgressiveJpegHandlerTransformStream(f);a=e.pipeThrough(b).pipeThrough(c);return d("WAResultOrError").makeResult(a)});return k.apply(this,arguments)}g.downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry=a}),98);
__d("WADownloadProgressiveJpegPlaintextStreamer",["WAAssertUnreachable","WACreateMediaDownloadRetrier","WADownloadProgressiveJpegPlaintextStreamerWithoutRetry","WAMediaUrl","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download with stream given up"]);h=function(){return a};return a}var i=d("WATagsLogger").TAGS(["WADownloadProgressiveJpegPlaintextStreamer"]);function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var e=a.serverMediaType,f=a.fileEncSha256,g=a.directPath,j=a.eventFlow,k=a.progressiveJpegDetails,l=a.mediaKey;a=(yield d("WACreateMediaDownloadRetrier").createMediaDownloadRetrier({directPath:g,eventFlow:j,fileEncSha256:f,mediaTypeDetails:{type:"regular",mediaType:e}}));if(!a.success)return a;a=a.value;var m=a.retrier;a=a.mediaRouteDetails;var n=a.bucket;a=(yield m.run(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.domain;a=d("WAMediaUrl").buildDownloadUrl(g,f,a,"manual",n);a=(yield d("WADownloadProgressiveJpegPlaintextStreamerWithoutRetry").downloadProgressiveJpegPlaintextUsingStreamsWithoutRetry({downloadUrl:a,eventFlow:j,mediaKey:l,progressiveJpegDetails:k,serverMediaType:e}));if(a.success===!0)return d("WAResultOrError").makeResult(a);a=a.error;switch(a){case"http-fetch-exception":case"server-timeout":case"unspecified-http-error":case"invalid-content-length-header":case"missing-content-length-header":return d("WAResultOrError").makeError({progressMade:!0});case"access-expired":return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("disconnected"));case"body-network-error":return d("WAResultOrError").makeResult(d("WAResultOrError").makeError("request-error"));case"media-not-found":case"request-error":case"download-throttled":case"signature-expired":return d("WAResultOrError").makeResult(d("WAResultOrError").makeError(a));case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return d("WAResultOrError").makeResult(d("WAResultOrError").makeError(a));default:a;throw c("WAAssertUnreachable")(a)}});return function(b){return a.apply(this,arguments)}}()));if(a==null){i.WARN(h());return d("WAResultOrError").makeError("max-attempts-exceeded")}return a});return j.apply(this,arguments)}g.downloadProgressiveJpegPlaintextUsingStreams=a}),98);
__d("WAGetAgeBucketForMediaKeyTimestamp",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)return"Missing";if(d("WATimeUtils").isInFuture(a))switch(!0){case d("WATimeUtils").happenedWithin(a,1*d("WATimeUtils").DAY_SECONDS):return"< 1 day in future";case d("WATimeUtils").happenedWithin(a,7*d("WATimeUtils").DAY_SECONDS):return"1-7 days in future";default:return"> 7 days in future"}switch(!0){case d("WATimeUtils").happenedWithin(a,1*d("WATimeUtils").DAY_SECONDS):return"< 1 day";case d("WATimeUtils").happenedWithin(a,7*d("WATimeUtils").DAY_SECONDS):return"1-7 days";case d("WATimeUtils").happenedWithin(a,14*d("WATimeUtils").DAY_SECONDS):return"7-14 days";case d("WATimeUtils").happenedWithin(a,21*d("WATimeUtils").DAY_SECONDS):return"14-21 days";case d("WATimeUtils").happenedWithin(a,30*d("WATimeUtils").DAY_SECONDS):return"21-30 days";case d("WATimeUtils").happenedWithin(a,40*d("WATimeUtils").DAY_SECONDS):return"30-40 days";case d("WATimeUtils").happenedWithin(a,50*d("WATimeUtils").DAY_SECONDS):return"40-50 days";case d("WATimeUtils").happenedWithin(a,60*d("WATimeUtils").DAY_SECONDS):return"50-60 days";default:return"> 60 days"}}g.getAgeBucketForMediaKeyTimestamp=a}),98);
__d("WAIsArmadilloMediaKeyExpired",["WAGlobals","WAResultOrError","WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a){if(a==null)return d("WAResultOrError").makeError("missing-media-key-timestamp");var b=d("WAGlobals").getConfig().mediaTtlOnWhatsAppInfraInDays()*d("WATimeUtils").DAY_SECONDS;return!d("WATimeUtils").happenedWithin(a,b)?d("WAResultOrError").makeError("media-key-expired"):d("WAResultOrError").makeResult()}g.isArmadilloMediaKeyExpired=a}),98);
__d("WAParseWav",["WAResultOrError"],(function(a,b,c,d,e,f,g){"use strict";function a(a){var b=new DataView(a);if(b.getUint32(0)!==1380533830||b.getUint32(8)!==1463899717)return d("WAResultOrError").makeError("invalid-wav");if(a.byteLength<44)return d("WAResultOrError").makeError("invalid-wav");a=b.getUint16(22,!0);b=b.getUint32(24,!0);return d("WAResultOrError").makeResult({numChannels:a,sampleRate:b})}g.parseWav=a}),98);
__d("WAProgressiveJpegAddJPEGTrailingTag",["WATypedArraysConcat"],(function(a,b,c,d,e,f,g){"use strict";var h=new Uint8Array([255,217]);function a(a){return d("WATypedArraysConcat").concatTypedArrays(Uint8Array,[new Uint8Array(a),h]).buffer}g.JPEG_TRAILING_TAG=h;g.addJPEGTrailingTag=a}),98);
__d("WADownloadMedia",["Promise","WAByteArray","WACryptoSha256","WACryptoUtils","WADownloadAndDecryptMedia","WADownloadDownloadablePreview","WADownloadProgressiveJpegPlaintextStreamer","WADownloadProgressiveJpegPreview","WAErrorMessage","WAGetAgeBucketForMediaKeyTimestamp","WAGlobals","WAHashUtils","WAIsArmadilloMediaKeyExpired","WALogger","WAMediaCrypto","WAMediaQplHelper","WAMediaUtils","WAParseWav","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAPromiseManagement","WAResolvable","WAResultOrError","WAStartMediaDownloadQplFlow","WATagsLogger","WATypedArraysConcat","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Exception occurred during Media Streaming: Reason: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download successful. PlaintextHash: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download failed due to plaintext hash mismatch. PlaintextHash: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media streaming for ProgressiveJpeg download failed due to plaintext hash mismatch"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Handling preview from scan "," for plaintextHash ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Processing scan "," for plaintextHash ",""]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Targeting scanIndex "," for preview. PlaintextHash: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using Media Streaming to download ProgressiveJpeg. PlaintextHash: ",""]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["ptt is not wav format"]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia: enc-hash-mismatch"]);r=function(){return a};return a}function s(){var a=babelHelpers.taggedTemplateLiteralLoose(["downloadMedia: enc-hash-mismatch. mediaTypeDetailsType: ",", mediaTypeDetailsValue: ",""]);s=function(){return a};return a}function t(){var a=babelHelpers.taggedTemplateLiteralLoose(["media already exists in db, skipping download"]);t=function(){return a};return a}function u(){var a=babelHelpers.taggedTemplateLiteralLoose(["Ignoring media downloads, continuing request after timeout: ","ms"]);u=function(){return a};return a}function v(){var a=babelHelpers.taggedTemplateLiteralLoose(["No media downloads in progress."]);v=function(){return a};return a}function w(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to download media due to runtime-error: ",""]);w=function(){return a};return a}function x(){var a=babelHelpers.taggedTemplateLiteralLoose(["start download ",". mediaKeyTimestampAgeBucket: ",", size: ",", serverMediaType: ",""]);x=function(){return a};return a}function y(){var a=babelHelpers.taggedTemplateLiteralLoose(["start downloadMedia."]);y=function(){return a};return a}function z(){var a=babelHelpers.taggedTemplateLiteralLoose(["start cachedDownloadFullMediaOnly"]);z=function(){return a};return a}function A(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media Entry size "," does not match decrypted plaintext size ",""]);A=function(){return a};return a}function B(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media Key Expired"]);B=function(){return a};return a}function C(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaEntry is incomplete"]);C=function(){return a};return a}function D(){var a=babelHelpers.taggedTemplateLiteralLoose([""," is not downloaded"]);D=function(){return a};return a}function E(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaPreviewPromise state: ",""]);E=function(){return a};return a}function F(){var a=babelHelpers.taggedTemplateLiteralLoose(["Falling back to full download"]);F=function(){return a};return a}function G(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media Streaming failed to download progressive jpeg. Reason: ",". PlaintextHash: ",""]);G=function(){return a};return a}function H(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media Streaming failed to download progressive jpeg. Reason: ","."]);H=function(){return a};return a}function I(){var a=babelHelpers.taggedTemplateLiteralLoose(["media: mediaPreview - unsupported preview media type ",""]);I=function(){return a};return a}function J(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to get ProgressiveJpeg details: ",""]);J=function(){return a};return a}function K(){var a=babelHelpers.taggedTemplateLiteralLoose(["Media Key Expired"]);K=function(){return a};return a}function L(){var a=babelHelpers.taggedTemplateLiteralLoose(["mediaEntry is incomplete"]);L=function(){return a};return a}function M(){var a=babelHelpers.taggedTemplateLiteralLoose([""," is not downloaded"]);M=function(){return a};return a}var N=d("WATagsLogger").TAGS(["MediaDownload"]),O=null,P=0;function a(a){return Q.apply(this,arguments)}function Q(){Q=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.minDelay,e=a.maxDelay;yield new(h||(h=b("Promise")))(function(a){return setTimeout(a,c)});if(O==null){d("WALogger").LOG(v());return(h||(h=b("Promise"))).resolve()}a=O.promise;var f,g=new h(function(a){d("WALogger").LOG(u(),e),f=setTimeout(function(){a()},e)});return h.race([a,g])["finally"](function(){clearTimeout(f)})});return Q.apply(this,arguments)}function c(a){var b=a.downloadMediaMetric,c=a.hash,e=a.mediaEntry,f=a.protocolMsgId,g=a.getMediaPlaintext,h=a.onlyIfMediaTTLIsValid,i=a.handleMediaPreviewDownload,j=a.handleMediaPreviewBeforeDownload;a=a.updateMediaEntryForMsg;var k=++P;O==null&&(O=new(d("WAResolvable").Resolvable)());var l=d("WAGlobals").getConfig().uiLayoutTriggeredMediaDownload()?S:R,m=Z({downloadMediaMetric:b,mediaEntry:e,hash:c});m=m.logDownloadResult;return m(l({downloadMediaMetric:b,hash:c,mediaEntry:e,protocolMsgId:f,getMediaPlaintext:g,handleMediaPreviewDownload:i,handleMediaPreviewBeforeDownload:j,updateMediaEntryForMsg:a,onlyIfMediaTTLIsValid:h}))["finally"](function(a){if(k===P){var b;(b=O)==null?void 0:b.resolve();O=null}return a})}var R=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.downloadMediaMetric,e=a.hash,f=a.mediaEntry,g=a.protocolMsgId,i=a.getMediaPlaintext,j=a.handleMediaPreviewDownload,k=a.handleMediaPreviewBeforeDownload,l=a.updateMediaEntryForMsg;a=a.onlyIfMediaTTLIsValid;var m=f.directPath,n=f.fileEncSha256,o=f.fileSha256,p=f.mediaKey,q=f.serverMediaType,r=f.mediaKeyTimestamp;if(m==null||n==null||o==null||p==null||q==null){N.WARN(M(),f);N.ERROR(L());return d("WAResultOrError").makeError("media-entry-invalid")}if(a){a=d("WAIsArmadilloMediaKeyExpired").isArmadilloMediaKeyExpired(r);if(!a.success){N.DEV(K());return(h||(h=b("Promise"))).resolve(a)}}(f==null?void 0:(r=f.downloadableThumbnail)==null?void 0:r.directPath)!=null&&c.addAnnotations({bool:{duplicateDirectPath:f.downloadableThumbnail.directPath===m,hasDownloadableThumbnail:!0}});a=d("WAProgressiveJpegGetPJpegDetails").maybeGetProgressiveJpegDetailsUsingMediaEntry(f);a.success===!1&&(N.ERROR(J(),a.error),c.addPoint(a.error));r=a.success===!0?a.value:null;c.addAnnotations({bool:{isProgressiveJpeg:r!=null}});a=function(a){if(a==null)return(h||(h=b("Promise"))).resolve();var c=d("WAMediaCrypto").convertServerMediaTypeToPreviewMediaType(q);if(c==null){N.ERROR(I(),q);return(h||(h=b("Promise"))).resolve()}return j(e,a,c,g).then(function(){})};if(r!=null&&d("WAMediaUtils").isTransformStreamSupported()&&q==="image"&&d("WAGlobals").getConfig().isMediaStreamingForProgressiveJpegEnabled()){m=(yield aa({directPath:m,downloadFlow:c,fileEncSha256:n,handleMediaPreviewBlob:a,hash:e,mediaKey:p,progressiveJpegDetails:r,serverMediaType:q,fileSha256:o,protocolMsgId:g}));if(m.success)return d("WAResultOrError").makeResult({mimeType:d("WAMediaUtils").getMimeTypeFromServerMediaType(q),plaintext:m.value});else{n=m.error;c==null?void 0:c.addPoint("media_streaming_failed");N.ERROR(H(),n);N.WARN(G(),n,d("WAHashUtils").sanitisePlaintextHash(e));N.LOG(F());c==null?void 0:c.addPoint("fallback_to_full_download")}}p=W({hash:e,mediaEntry:f,progressiveJpegDetails:r,protocolMsgId:g,serverMediaType:q,getMediaPlaintext:i,handleMediaPreviewBeforeDownload:k,updateMediaEntryForMsg:l,downloadEntry:c.downloadEntry});void p.then(a);o=(yield T({downloadMediaMetric:c,hash:e,mediaEntry:f,protocolMsgId:g,getMediaPlaintext:i,updateMediaEntryForMsg:l,onlyIfMediaTTLIsValid:!1}));m=(yield ba(p));N.LOG(E(),m);(f==null?void 0:(n=f.downloadableThumbnail)==null?void 0:n.directPath)!=null&&c.addAnnotations({string:{mediaPreviewPromiseState:m}});return o});return function(b){return a.apply(this,arguments)}}(),S=d("WAPromiseManagement").cacheWhilePending(function(a){a=a.hash;return a},R),T=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.downloadMediaMetric,e=a.hash,f=a.mediaEntry,g=a.protocolMsgId,i=a.getMediaPlaintext,j=a.updateMediaEntryForMsg;a=a.onlyIfMediaTTLIsValid;var k=f.directPath,l=f.fbid,m=f.fileEncSha256,n=f.fileSha256,o=f.mediaKey,p=f.objectId,q=f.serverMediaType,r=f.size,s=f.mediaKeyTimestamp;if(k==null||m==null||n==null||o==null||q==null){N.WARN(D(),f);N.ERROR(C());return d("WAResultOrError").makeError("media-entry-invalid")}if(a){a=d("WAIsArmadilloMediaKeyExpired").isArmadilloMediaKeyExpired(s);if(!a.success){N.DEV(B());return(h||(h=b("Promise"))).resolve(a)}}s=(yield U(g,e,c,{mediaType:q,type:"regular"},k,m,n,o,p,l,f,{getMediaPlaintext:i,updateMediaEntryForMsg:j}));if(s.success){r!=null&&(r!==s.value.byteLength&&(N.WARN(A(),r,s.value.byteLength),c.addPoint("legacy_plaintext_size_mismatch")));a={mimeType:d("WAMediaUtils").getMimeTypeFromServerMediaType(q),plaintext:s.value};return d("WAResultOrError").makeResult(a)}else return s});return function(b){return a.apply(this,arguments)}}();e=d("WAPromiseManagement").cacheWhilePending(function(a){a=a.hash;return a},function(a){N.DEV(z());var b=Z({hash:a.hash,downloadMediaMetric:a.downloadMediaMetric,mediaEntry:a.mediaEntry});b=b.logDownloadResult;return b(T(a))});function U(a,b,c,d,e,f,g,h,i,j,k,l){return V.apply(this,arguments)}function V(){V=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e,f,g,h,i,j,k,l,m,n){c=n.getMediaPlaintext;var o=n.updateMediaEntryForMsg,p=d("WAHashUtils").toPlaintextHash(i);if(d("WAGlobals").getConfig().mediaDownloadDeduplication()&&(f.mediaType==="gif"||f.mediaType==="sticker")){n=(yield c(p));if(n!=null){N.LOG(t());e.addPoint("media_download_skipped");i=(yield d("WAMediaUtils").blobToArrayBuffer(n));return d("WAResultOrError").makeResult(i)}}e.addAnnotations({bool:{downloadSkipped:!1}});c=(yield d("WADownloadAndDecryptMedia").downloadAndDecryptMedia({directPath:g,eventFlow:e,fbid:l,fileEncSha256:h,mediaKey:j,mediaTypeDetails:f,objectId:k,pathRedirected:function(){var c=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){var c=function(){return d("WAMediaUtils").encodeMediaEntryWithUpdatedPath(m,b)};yield o(p,a,c,k,m.serverMediaType)});function e(a){return c.apply(this,arguments)}return e}(),plaintextHash:p}));if(c.success===!1){n=c.error;switch(n){case"signature-expired":case"signature-expired-and-resign-failed-cdn-url":case"signature-expired-and-resign-failed-no-ids":case"media-not-found":return d("WAResultOrError").makeError(n);case"enc-hash-mismatch":N.WARN(s(),f.type,f.type==="regular"?f.mediaType:f.messageType);N.ERROR(r());return d("WAResultOrError").makeError(n);default:n;return d("WAResultOrError").makeError(n)}}else{i=c.value;if(f.type==="regular"&&f.mediaType==="ptt"){g=d("WAParseWav").parseWav(i);!g.success?N.DEV(q()):e.addAnnotations({"int":{pttNumChannels:g.value.numChannels,pttSampleRate:g.value.sampleRate}})}e.addPoint("download_media_success",{string:{media_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket(i.byteLength)}});return d("WAResultOrError").makeResult(i)}});return V.apply(this,arguments)}function W(a){var b=a.hash,c=a.mediaEntry,e=a.progressiveJpegDetails,f=a.protocolMsgId,g=a.serverMediaType,h=a.getMediaPlaintext,i=a.handleMediaPreviewBeforeDownload,j=a.updateMediaEntryForMsg,k=a.downloadEntry;return e==null||!d("WAGlobals").getConfig().isProgressiveJpegEnabledForDownload()?d("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(f,b,g,c,k,{getMediaPlaintext:h,handleMediaPreviewBeforeDownload:i,updateMediaEntryForMsg:j}):d("WADownloadProgressiveJpegPreview").maybeDownloadProgressiveJpegPreview({protocolMsgId:f,hash:b,serverMediaType:g,mediaEntry:c,progressiveJpegDetails:e,getMediaPlaintext:h,handleMediaPreviewBeforeDownload:i,downloadEntry:k}).then(function(a){return a.success!==!0?d("WADownloadDownloadablePreview").maybeDownloadDownloadablePreview(f,b,g,c,k,{getMediaPlaintext:h,handleMediaPreviewBeforeDownload:i,updateMediaEntryForMsg:j}):a.value})}function aa(a){return X.apply(this,arguments)}function X(){X=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.directPath,c=a.downloadFlow,e=a.fileEncSha256,f=a.fileSha256,g=a.handleMediaPreviewBlob,h=a.hash,q=a.mediaKey,r=a.progressiveJpegDetails,s=a.serverMediaType;a=a.protocolMsgId;var t=N.TAGS(["MediaStreaming"]);t.LOG(p(),d("WAHashUtils").sanitisePlaintextHash(h));c==null?void 0:c.addPoint("media_streaming_start");var u=d("WADownloadProgressiveJpegPreview").getPreviewTargetScan(r.scanLengths)-1;t.LOG(o(),u,d("WAHashUtils").sanitisePlaintextHash(h));var v=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:a,downloadEntry:c.downloadEntry+"-streaming-preview",msgType:null});v.addAnnotations({bool:{isProgressiveJpeg:!0},string:{mediaType:"preview",fullSizeMediaType:s}});v.addPoint("wa_protocol_media_download_start");a={addAnnotations:function(a){c.addAnnotations(a),v.addAnnotations(a)},addPoint:function(a,b){c.addPoint(a,b),v.addPoint(a,b)},endSuccess:function(a){c.endSuccess(a),v.endSuccess(a)},endFail:function(a,b){c.endFail(a,b),v.endFail(a,b)},downloadEntry:c.downloadEntry};b=(yield d("WADownloadProgressiveJpegPlaintextStreamer").downloadProgressiveJpegPlaintextUsingStreams({directPath:b,eventFlow:a,fileEncSha256:e,mediaKey:q,progressiveJpegDetails:r,serverMediaType:s}));if(b.success===!1){v.addPoint("wa_protocol_media_download_fail");v.endFail(b.error);return b}a=[];e=0;try{q=!0;r=!1;var w;try{for(var x=babelHelpers.asyncIterator(ca(b.value)),s,b;s=(yield x.next()),q=s.done,b=(yield s.value),!q;q=!0){s=b;if(s==null)continue;t.LOG(n(),e,d("WAHashUtils").sanitisePlaintextHash(h));a.push(s);if(e===u){c==null?void 0:c.addPoint("media_streaming_preview_processed");t.LOG(m(),e,d("WAHashUtils").sanitisePlaintextHash(h));b=d("WAByteArray").uint8ArrayToBuffer(d("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(a,[d("WAProgressiveJpegAddJPEGTrailingTag").JPEG_TRAILING_TAG])));void g(b);v.addPoint("wa_protocol_media_download_end",{"int":{byteLength:b.byteLength}});v.endSuccess()}e++}}catch(a){r=!0,w=a}finally{try{!q&&x["return"]!=null&&(yield x["return"]())}finally{if(r)throw w}}(v.isActive==null?void 0:v.isActive())===!0&&(v.addPoint("wa_protocol_media_download_fail"),v.endFail("streaming_no_preview"));c==null?void 0:c.addPoint("media_streaming_finish");s=d("WAByteArray").uint8ArrayToBuffer(d("WATypedArraysConcat").concatTypedArrays(Uint8Array,[].concat(a)));b=(yield d("WACryptoSha256").sha256(s));if(!d("WACryptoUtils").arrayBuffersEqual(f,b)){t.ERROR(l());t.WARN(k(),d("WAHashUtils").sanitisePlaintextHash(h));c==null?void 0:c.addPoint("streaming_plaintext_hash_mismatch");return d("WAResultOrError").makeError("hash-mismatch")}t.LOG(j(),d("WAHashUtils").sanitisePlaintextHash(h));c==null?void 0:c.addAnnotations({string:{media_size:d("WAMediaQplHelper").convertIntegerSizeToStringBucket(s.byteLength)}});return d("WAResultOrError").makeResult(s)}catch(a){t.ERROR(i(),a);(v.isActive==null?void 0:v.isActive())===!0&&(v.addPoint("wa_protocol_media_download_fail"),v.endFail("unexpected_exception"));return d("WAResultOrError").makeError("stream-error")}});return X.apply(this,arguments)}var Y=0;function Z(a){var c=a.downloadMediaMetric,e=a.mediaEntry;a=a.hash;N.DEV(y());var f=e.mediaKeyTimestamp,g=e.size;e=e.serverMediaType;f=d("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(f);N.LOG(x(),d("WAHashUtils").sanitisePlaintextHash(a),f,g,e);c.addPoint("wa_protocol_media_download_start",{string:{mediaType:e,mediaKeyTimestampAgeBucket:f},"int":{mediaEntrySize:g},bool:{isMediaStreamingForProgressiveJpegEnabled:d("WAGlobals").getConfig().isMediaStreamingForProgressiveJpegEnabled()}});return{logDownloadResult:function(a){Y++;c.addAnnotations({"int":{concurrentDownloadCount:Y}});return a.then(function(a){a.success?c.addPoint("wa_protocol_media_download_end"):c.addPoint("wa_protocol_media_download_fail",{string:{wa_protocol_media_download_fail_reason:a.error}});return a})["catch"](function(a){c.addPoint("wa_protocol_media_download_fail");a=d("WAErrorMessage").maybeGetMessageFromError(a);N.ERROR(w(),a);return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeError("runtime-error"))})["finally"](function(){Y--})}}}function ba(a){var c={};return(h||(h=b("Promise"))).race([a,c]).then(function(a){return a===c?"pending":"fulfilled"},function(){return"rejected"})}function ca(a){return $.apply(this,arguments)}function $(){$=babelHelpers.wrapAsyncGenerator(function*(a){a=a.getReader();try{while(!0){var b=(yield babelHelpers.awaitAsyncGenerator(a.read())),c=b.done;b=b.value;if(c)return;yield b}}finally{a.releaseLock()}});return $.apply(this,arguments)}g.mediaDownloadLogger=N;g.onFinishDownloads=a;g.downloadMedia=c;g.cachedDownloadFullMediaOnly=e;g.downloadMediaImpl=U}),98);
__d("WADownloadProgressiveJpegPlaintext",["WADownloadCiphertext","WAMediaCrypto","WAProgressiveJpegAddJPEGTrailingTag","WAProgressiveJpegGetPJpegDetails","WAResultOrError","WATagsLogger","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["ProgressiveJpeg download and decrypt successful. Partial: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Download Plaintext Error ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Using progressiveJpeg decryptAndVerify"]);j=function(){return a};return a}var k=d("WATagsLogger").TAGS(["DownloadProgressiveJpeg"]);function a(a){var c,e,f,g,h,i,j,k,n,o,p,q,r;return b("regeneratorRuntime").async(function(s){while(1)switch(s.prev=s.next){case 0:c=a.mediaTypeDetails,e=a.fileEncSha256,f=a.directPath,g=a.mediaKey,h=a.eventFlow,i=a.pathRedirected,j=a.progressiveJpegDetails,k=a.targetScan,n=a.plaintextHash,o=a.size;p=d("WAProgressiveJpegGetPJpegDetails").getExtendedProgressiveJpegDetails({progressiveJpegDetails:j,ciphertextLength:m(o)});q=d("WAProgressiveJpegGetPJpegDetails").getTotalByteSizeForScan(p.alignedScanLengths,k);s.next=5;return b("regeneratorRuntime").awrap(d("WADownloadCiphertext").cachedDownloadCiphertext({mediaTypeDetails:c,fileEncSha256:e,directPath:f,pathRedirected:i,fromBytes:0,toBytes:q-1,eventFlow:h,plaintextHash:n}));case 5:r=s.sent;if(!(r.success!==!0)){s.next=8;break}return s.abrupt("return",r);case 8:return s.abrupt("return",l(g,c,k,p,r.value));case 9:case"end":return s.stop()}},null,this)}function l(a,c,e,f,g){var l,m,n,o;return b("regeneratorRuntime").async(function(p){while(1)switch(p.prev=p.next){case 0:k.LOG(j());l=new Uint8Array(g);c.type==="preview"?m=d("WAMediaCrypto").computeMediaKeysForPreview(a):m=d("WAMediaCrypto").computeMediaKeys(a,c.mediaType);p.next=5;return b("regeneratorRuntime").awrap(m.then(function(a){var b=a.iv,c=a.cipherKey;a=a.hmacKey;return d("WAMediaCrypto").decryptPartialChunks(c,b,l,a,e,f)}).then(d("WAResultOrError").makeResult)["catch"](function(a){k.ERROR(i(),a);if(a instanceof d("WAMediaCrypto").HmacValidationError)return d("WAResultOrError").makeError("enc-hash-mismatch");else return d("WAResultOrError").makeError("decryption-error")}));case 5:n=p.sent;if(n.success){p.next=8;break}return p.abrupt("return",n);case 8:k.LOG(h(),e<f.scanLengths.length);o=d("WAProgressiveJpegAddJPEGTrailingTag").addJPEGTrailingTag(n.value.plaintext);return p.abrupt("return",d("WAResultOrError").makeResult(o));case 11:case"end":return p.stop()}},null,this)}function m(a){if(a==null)return null;var b=d("WAMediaCrypto").CBC_BLOCK_SIZE-a%d("WAMediaCrypto").CBC_BLOCK_SIZE;return a+b+d("WAMediaCrypto").HMAC_LENGTH}g.downloadProgressiveJpegPlaintext=a}),98);
__d("WAProgressiveJpegGetTargetScanLengthForBytes",[],(function(a,b,c,d,e,f){"use strict";function a(a,b){var c=0,d=0;for(var e=0;e<a.length;e++){d=e+1;c+=a[e];if(c>=b)break}return d}f.getTargetScanBasedOnByteSize=a}),66);
__d("WADownloadProgressiveJpegPreview",["WADownloadMedia","WADownloadProgressiveJpegPlaintext","WAGlobals","WALoggerTag","WAMediaUtils","WAProgressiveJpegGetTargetScanLengthForBytes","WAResultOrError","WAStartMediaDownloadQplFlow","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Finished progressiveJpeg preview download"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["media already exists in db, skipping download"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Starting progressiveJpeg preview download"]);j=function(){return a};return a}var k=d("WADownloadMedia").mediaDownloadLogger.TAGS([c("WALoggerTag").MediaPreview]),l=d("WAGlobals").getConfig().jpegThumbnailTargetByteSizeKB()*1024,m=3;function a(a){return n.apply(this,arguments)}function n(){n=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=a.protocolMsgId,c=a.hash,e=a.serverMediaType,f=a.mediaEntry,g=a.progressiveJpegDetails,l=a.getMediaPlaintext,m=a.handleMediaPreviewBeforeDownload;a=a.downloadEntry;var n=f.directPath,p=f.fileEncSha256,q=f.mediaKey,r=f.size;if(n==null||p==null||q==null)return d("WAResultOrError").makeError("pjpeg-failed");yield m(c);m=d("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({protocolMsgId:b,downloadEntry:a+"-preview",msgType:null});m.addAnnotations({bool:{isMediaFallbackToAlternativeHmacSaltsEnabled:d("WAGlobals").getConfig().isMediaFallbackToAlternativeHmacSaltsEnabled(),isProgressiveJpeg:!0},string:{mediaType:"preview",fullSizeMediaType:f.serverMediaType},"int":{mediaEntrySize:f.size}});k.LOG(j());m.addPoint("wa_protocol_media_download_start");if(g.scanLengths.length<3){m.endFail("pjpeg-too-few-scans");return d("WAResultOrError").makeError("pjpeg-failed")}b=d("WAGlobals").getConfig().pjpegPreviewAvoidLastScan()===!0?g.scanLengths.length-1:g.scanLengths.length;a=Math.min(o(g.scanLengths,r),b);if(d("WAGlobals").getConfig().mediaDownloadDeduplication()&&(e==="gif"||e==="sticker")){f=(yield l(c));if(f!=null){k.LOG(i());b=(yield d("WAMediaUtils").blobToArrayBuffer(f));m.addPoint("media_download_skipped");m.addPoint("wa_protocol_media_download_end");m.endSuccess();return d("WAResultOrError").makeResult(b)}}l=(yield d("WADownloadProgressiveJpegPlaintext").downloadProgressiveJpegPlaintext({directPath:n,eventFlow:m,fileEncSha256:p,mediaKey:q,mediaTypeDetails:{mediaType:e,type:"regular"},progressiveJpegDetails:g,plaintextHash:c,targetScan:a,size:r}));if(!l.success){m.addPoint("wa_protocol_media_download_fail");m.endFail(l.error);return d("WAResultOrError").makeError("pjpeg-failed")}f=l.value;k.LOG(h());m.addPoint("wa_protocol_media_download_end");m.endSuccess();return d("WAResultOrError").makeResult(f)});return n.apply(this,arguments)}function o(a,b){var c=d("WAProgressiveJpegGetTargetScanLengthForBytes").getTargetScanBasedOnByteSize(a,l);(b==null||b===0)&&(c=Math.min(c,a.length-1));c=Math.max(c,m);return c}g.maybeDownloadProgressiveJpegPreview=a;g.getPreviewTargetScan=o}),98);
__d("WASmaxInDevicesFetchSelfResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInDevicesRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup").parseRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup:b.value}))}g.parseFetchSelfResponseError=a}),98);
__d("WASmaxInDevicesDeviceInfoMixin",["WAResultOrError","WASmaxInDevicesIdentityKeyMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"platform");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function i(a){var b=d("WASmaxParseUtils").assertTag(a,"manufacturer");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function j(a){var b=d("WASmaxParseUtils").assertTag(a,"model");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function k(a){var b=d("WASmaxParseUtils").assertTag(a,"seen");if(!b.success)return b;b=d("WASmaxParseUtils").contentInt(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function l(a){var b=d("WASmaxParseUtils").assertTag(a,"creation");if(!b.success)return b;b=d("WASmaxParseUtils").contentInt(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function m(a){var b=d("WASmaxParseUtils").assertTag(a,"ip");if(!b.success)return b;b=d("WASmaxParseUtils").contentString(a);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function n(a){var b=d("WASmaxParseUtils").assertTag(a,"location");if(!b.success)return b;b=d("WASmaxParseUtils").attrString(a,"latitude");if(!b.success)return b;var c=d("WASmaxParseUtils").attrString(a,"longitude");if(!c.success)return c;a=d("WASmaxParseUtils").contentString(a);return!a.success?a:d("WAResultOrError").makeResult({latitude:b.value,longitude:c.value,elementValue:a.value})}function a(a){var b=d("WASmaxParseUtils").assertTag(a,"device");if(!b.success)return b;b=d("WASmaxParseUtils").optionalChildWithTag(a,"platform",h);if(!b.success)return b;var c=d("WASmaxParseUtils").optionalChildWithTag(a,"manufacturer",i);if(!c.success)return c;var e=d("WASmaxParseUtils").optionalChildWithTag(a,"model",j);if(!e.success)return e;var f=d("WASmaxParseUtils").optionalChildWithTag(a,"seen",k);if(!f.success)return f;var g=d("WASmaxParseUtils").optionalChildWithTag(a,"creation",l);if(!g.success)return g;var o=d("WASmaxParseUtils").optionalChildWithTag(a,"ip",m);if(!o.success)return o;var p=d("WASmaxParseUtils").optionalChildWithTag(a,"location",n);if(!p.success)return p;var q=d("WASmaxParseUtils").attrIntRange(a,"id",1,999);if(!q.success)return q;a=d("WASmaxInDevicesIdentityKeyMixin").parseIdentityKeyMixin(a);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({id:q.value},a.value,{platform:b.value,manufacturer:c.value,model:e.value,seen:f.value,creation:g.value,ip:o.value,location:p.value}))}g.parseDeviceInfoPlatform=h;g.parseDeviceInfoManufacturer=i;g.parseDeviceInfoModel=j;g.parseDeviceInfoSeen=k;g.parseDeviceInfoCreation=l;g.parseDeviceInfoIp=m;g.parseDeviceInfoLocation=n;g.parseDeviceInfoMixin=a}),98);
__d("WASmaxInDevicesFetchSelfResponseSuccess",["WAResultOrError","WASmaxInDevicesDeviceInfoMixin","WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"device");if(!b.success)return b;b=d("WASmaxInDevicesDeviceInfoMixin").parseDeviceInfoMixin(a);return!b.success?b:b}function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"self");if(!c.success)return c;a=d("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxParseUtils").mapChildrenWithTag(c.value,"device",1,25,h);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{selfDevice:b.value}))}g.parseFetchSelfResponseSuccessSelfDevice=h;g.parseFetchSelfResponseSuccess=a}),98);
__d("WASmaxOutDevicesFetchSelfRequest",["WASmaxJsx","WASmaxOutDevicesBaseIQGetRequestMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(){var a=d("WASmaxOutDevicesBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(d("WASmaxJsx").smax("iq",{to:d("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},d("WASmaxJsx").smax("self",null)));return a}g.makeFetchSelfRequest=a}),98);
__d("WASmaxDevicesFetchSelfRPC",["WAComms","WASmaxInDevicesFetchSelfResponseError","WASmaxInDevicesFetchSelfResponseSuccess","WASmaxOutDevicesFetchSelfRequest","WASmaxParsingFailure","WASmaxRpcUtils","regeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a){var c,e,f,g;return b("regeneratorRuntime").async(function(h){while(1)switch(h.prev=h.next){case 0:c=d("WASmaxOutDevicesFetchSelfRequest").makeFetchSelfRequest();h.next=3;return b("regeneratorRuntime").awrap(d("WAComms").sendSmaxStanza(c,a));case 3:e=h.sent;f=d("WASmaxInDevicesFetchSelfResponseSuccess").parseFetchSelfResponseSuccess(e,c);if(!f.success){h.next=7;break}return h.abrupt("return",{name:"FetchSelfResponseSuccess",value:f.value});case 7:g=d("WASmaxInDevicesFetchSelfResponseError").parseFetchSelfResponseError(e,c);if(!g.success){h.next=10;break}return h.abrupt("return",{name:"FetchSelfResponseError",value:g.value});case 10:throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("FetchSelf",{Success:f,Error:g}));case 11:case"end":return h.stop()}},null,this)}g.sendFetchSelfRPC=a}),98);
__d("WAGetCurrentUserDeviceList",["WAAssertUnreachable","WAErr","WAGlobals","WAJids","WALogger","WAPersistedJobManager","WASignalKeys","WASmaxDevicesFetchSelfRPC","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Two devices were detected as isCurrentDevice in getCurrentUserDeviceList"]);h=function(){return a};return a}function i(a,b){if(a.isCurrentDevice&&b.isCurrentDevice){d("WALogger").ERROR(h());return 0}if(a.isCurrentDevice)return-1;if(b.isCurrentDevice)return 1;if(a.lastSeen!=null&&b.lastSeen==null)return-1;if(a.lastSeen==null&&b.lastSeen!=null)return 1;if(a.lastSeen!=null&&b.lastSeen!=null){a=a.lastSeen;b=b.lastSeen;return b.getTime()-a.getTime()}return 0}function a(a){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=(yield d("WASmaxDevicesFetchSelfRPC").sendFetchSelfRPC());switch(a.name){case"FetchSelfResponseError":var b=a.value.errorRetryableIQErrorOrNonRetryableIQErrorRetryableIQErrorMixinGroup;switch(b.name){case"RetryableIQError":var e=b.value.backoff;if(e!=null)throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{delay:e,type:"constant"},jitter:0});else throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{first:d("WATimeUtils").HOUR_MILLISECONDS/60,type:"exponential"},jitter:.1});default:b.name;e=b.value.code;throw c("WAErr")("Failed with an error code "+e)}case"FetchSelfResponseSuccess":var f=d("WAJids").extractDeviceId(d("WAGlobals").getMyDeviceJid());return a.value.selfDevice.map(function(a){var b=a.creation,c=a.elementValue,e=a.id,g=a.ip,h=a.location,i=a.manufacturer,j=a.model,k=a.platform;a=a.seen;return{creationTime:b==null?null:d("WATimeUtils").toDate(d("WATimeUtils").castToUnixTime(b.elementValue)),id:d("WAJids").interpretAsDeviceId(e),identityKey:d("WASignalKeys").serializeIdentity(c),ipAddress:(b=g==null?void 0:g.elementValue)!=null?b:null,isCurrentDevice:e===f,lastSeen:a==null?null:d("WATimeUtils").toDate(d("WATimeUtils").castToUnixTime(a.elementValue)),latitude:h==null?null:parseFloat(h.latitude),location:(c=h==null?void 0:h.elementValue)!=null?c:null,longitude:h==null?null:parseFloat(h.longitude),manufacturer:(g=i==null?void 0:i.elementValue)!=null?g:null,model:(b=j==null?void 0:j.elementValue)!=null?b:null,platform:(e=k==null?void 0:k.elementValue)!=null?e:null}}).sort(i);default:return c("WAAssertUnreachable")(a.name)}});return j.apply(this,arguments)}g.getCurrentUserDeviceList=a}),98);
__d("WAPreEstablishOutgoingSessionForGroup",["Promise","WACryptoManagerUtils","WAGlobals","WAPushSafeTypes","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h,i=new Set();function a(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c){a=d("WAPushSafeTypes").unsafeNotNullable(c);c=a.groupJid;var e=a.userJids;if(!d("WAGlobals").getConfig().isPreEstablishSessionEnabled())return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult());if(i.has(c))return(h||(h=b("Promise"))).resolve(d("WAResultOrError").makeResult());yield d("WAGlobals").getWaOneQueue().enqueue(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var b=(yield a.cryptoManager.storage.bulkLoadIdentities(e));b=Array.from(b).flatMap(function(a){a=a[1];return Array.from(a.keys())});return d("WACryptoManagerUtils").bulkPreEstablishOutgoingSession(b,a)});return function(b){return a.apply(this,arguments)}}(),{flush:!0,afterInit:!0,operationType:"pre_establish_session"});i.add(c);return d("WAResultOrError").makeResult()});return j.apply(this,arguments)}g.preEstablishSession=a}),98);
__d("WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup",["WAResultOrError","WASmaxInDevicesIQErrorBadRequestMixin","WASmaxInDevicesIQErrorItemNotFoundMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInDevicesIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"IQErrorBadRequest",value:b.value});var c=d("WASmaxInDevicesIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(a);return c.success?d("WAResultOrError").makeResult({name:"IQErrorItemNotFound",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["IQErrorBadRequest","IQErrorItemNotFound"],[b,c])}g.parseIQErrorBadRequestOrItemNotFoundMixinGroup=a}),98);
__d("WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin",["WAResultOrError","WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxInDevicesIQErrorBadRequestOrItemNotFoundMixinGroup").parseIQErrorBadRequestOrItemNotFoundMixinGroup(a);return!b.success?b:d("WAResultOrError").makeResult({iQErrorBadRequestOrItemNotFoundMixinGroup:b.value})}g.parseNonRetryableRemoveDeviceIQErrorMixin=a}),98);
__d("WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup",["WAResultOrError","WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin","WASmaxInDevicesRetryableIQErrorMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInDevicesRetryableIQErrorMixin").parseRetryableIQErrorMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"RetryableIQError",value:b.value});var c=d("WASmaxInDevicesNonRetryableRemoveDeviceIQErrorMixin").parseNonRetryableRemoveDeviceIQErrorMixin(a);return c.success?d("WAResultOrError").makeResult({name:"NonRetryableRemoveDeviceIQError",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["RetryableIQError","NonRetryableRemoveDeviceIQError"],[b,c])}g.parseRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup=a}),98);
__d("WASmaxInDevicesRemoveResponseError",["WAResultOrError","WASmaxInDevicesIQErrorResponseMixin","WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInDevicesIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInDevicesRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup").parseRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup:b.value}))}g.parseRemoveResponseError=a}),98);
__d("WASmaxInDevicesRemoveResponseSuccess",["WASmaxInDevicesIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxInDevicesIQResultResponseMixin").parseIQResultResponseMixin(a,b);return!c.success?c:c}g.parseRemoveResponseSuccess=a}),98);
__d("WASmaxOutDevicesKeyDataMixin",["WASmaxJsx","WASmaxMixins"],(function(a,b,c,d,e,f,g){function h(a){a=a.anyElementValue;a=d("WASmaxJsx").smax("smax$any",null,a);return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeKeyDataMixin=a}),98);
__d("WASmaxOutDevicesIdentityKeyMixin",["WASmaxJsx","WASmaxMixins","WASmaxOutDevicesKeyDataMixin"],(function(a,b,c,d,e,f,g){function h(a){a=d("WASmaxJsx").smax("smax$any",null,d("WASmaxOutDevicesKeyDataMixin").mergeKeyDataMixin(d("WASmaxJsx").smax("identity",null),a));return a}function a(a,b){b=h(b);return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeIdentityKeyMixin=a}),98);
__d("WASmaxOutDevicesRemoveRequest",["WASmaxJsx","WASmaxOutDevicesBaseIQSetRequestMixin","WASmaxOutDevicesIdentityKeyMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(a){var b=a.removeId;a=a.identityKeyMixinArgs;b=d("WASmaxOutDevicesBaseIQSetRequestMixin").mergeBaseIQSetRequestMixin(d("WASmaxJsx").smax("iq",{to:d("WAWap").S_WHATSAPP_NET,xmlns:"fbid:devices"},d("WASmaxOutDevicesIdentityKeyMixin").mergeIdentityKeyMixin(d("WASmaxJsx").smax("remove",{id:d("WAWap").INT(b)}),a)));return b}g.makeRemoveRequest=a}),98);
__d("WASmaxDevicesRemoveRPC",["WAComms","WASmaxInDevicesRemoveResponseError","WASmaxInDevicesRemoveResponseSuccess","WASmaxOutDevicesRemoveRequest","WASmaxParsingFailure","WASmaxRpcUtils","regeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a,c){var e,f,g,h;return b("regeneratorRuntime").async(function(i){while(1)switch(i.prev=i.next){case 0:e=d("WASmaxOutDevicesRemoveRequest").makeRemoveRequest(a);i.next=3;return b("regeneratorRuntime").awrap(d("WAComms").sendSmaxStanza(e,c));case 3:f=i.sent;g=d("WASmaxInDevicesRemoveResponseSuccess").parseRemoveResponseSuccess(f,e);if(!g.success){i.next=7;break}return i.abrupt("return",{name:"RemoveResponseSuccess",value:g.value});case 7:h=d("WASmaxInDevicesRemoveResponseError").parseRemoveResponseError(f,e);if(!h.success){i.next=10;break}return i.abrupt("return",{name:"RemoveResponseError",value:h.value});case 10:throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("Remove",{Success:g,Error:h}));case 11:case"end":return i.stop()}},null,this)}g.sendRemoveRPC=a}),98);
__d("WARemoveDevice",["WALogger","WAPersistedJobManager","WAPushSafeTypes","WAResultOrError","WASignalOther","WASmaxDevicesRemoveRPC","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["removeDevice result for ",": "," "]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["removeDevice called for device "," and identity ",""]);i=function(){return a};return a}function a(a,b){return j.apply(this,arguments)}function j(){j=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=d("WAPushSafeTypes").unsafeNotNullable(b);b=a.deviceId;a=a.identity;d("WALogger").DEV(i(),b,a);a=d("WASignalOther").sliceBytes(a,1,32);a=(yield d("WASmaxDevicesRemoveRPC").sendRemoveRPC({removeId:b,identityKeyMixinArgs:{anyElementValue:a}}));d("WALogger").LOG(h(),b,a);if(a.name==="RemoveResponseSuccess")return d("WAResultOrError").makeResult();else{a.name;b=a.value.errorRetryableOrNonRetryableRemoveDeviceIQErrorMixinGroup;if(b.name!=="RetryableIQError")return d("WAResultOrError").makeError();b.name;a=b.value.backoff;if(a!=null)throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{type:"constant",delay:a},jitter:0});else throw new(d("WAPersistedJobManager").RetryOnBackoff)({algo:{type:"exponential",first:d("WATimeUtils").HOUR_MILLISECONDS/60},jitter:.1})}});return j.apply(this,arguments)}g.removeDevice=a}),98);
__d("WARemoveCurrentDevice",["WAGetCurrentUserDeviceInfoApi","WAGlobals","WALogger","WARemoveDevice","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["There is no stored user info, it was already deleted or this job was called twice, possibly from another tab"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["removeCurrentDevice called for current device"]);i=function(){return a};return a}a=function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){d("WALogger").DEV(i());var b=(yield d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo());if(b==null){d("WALogger").WARN(h());return d("WAResultOrError").makeResult()}var c=b.deviceId;b=b.identityKey;a=(yield d("WARemoveDevice").removeDevice(a,{deviceId:c,identity:b}));if(a.success){yield d("WAGlobals").getDependencies().clearSignalAndTempStores();return d("WAResultOrError").makeResult()}return d("WAResultOrError").makeResult()});return function(b){return a.apply(this,arguments)}}();g.removeCurrentDevice=a}),98);
__d("WASendAppDataFanoutProtocol",["WAAsMessageApplication","WABridge","WAConvertAppData","WAEncUserMsg","WAErrorMessage","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAMsgApplication.pb","WAOdsEnums","WAResultOrError","WASmaxAppdataPublishPeerRPC","WATagsLogger","asyncToGeneratorRuntime","encodeProtobuf"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata. Error: ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Got phash mismatch on appdata, local[","] server[","]"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Attempting to send an appData stanza to more than the allowed "," devices"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Attempting to send an appData stanza to "," devices"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Sending appdata, externalId: ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata to devices with error: ",""]);n=function(){return a};return a}var o=d("WATagsLogger").TAGS(["sendAppDataFanout"]),p=24;function a(a,b){a=b.contents;var c=b.externalId,e=b.permittedIdentitiesPerDevice;b=b.checkPhash;b=b===void 0?"checkPhash":b;return q(a,c,e,b)["catch"](function(a){a=d("WAErrorMessage").maybeGetMessageFromError(a);o.ERROR(n(),a);return d("WAResultOrError").makeError("runtime-error")})}function q(a,b,c,d){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c,e){e===void 0&&(e="checkPhash");o.LOG(m(),b);a=d("WAConvertAppData").convertAppData(a);var f={bytes:d("WAAsMessageApplication").castToMessageApplicationBytes(d("encodeProtobuf").encodeProtobuf(d("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArray()),version:"v3"},g=[];a=Array.from(c.entries()).map(function(a){var b=a[0];a=a[1];return{identity:a.pubKey,jid:b}});c=p;a.length>c&&(o.WARN(l(),a.length),o.ERROR(k(),c),a=a.slice(0,c));var n=[{devicesInfo:a,user:d("WAGlobals").getMyUserJid()}];c=(yield d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return d("WAEncUserMsg").encryptUserMsg(n,{messageBytes:f,type:"appdata"},[],{cryptoManager:a})},{operationType:"encrypt",flush:!0}));a=c.phash;var q=!1;c.participants!=null&&c.participants.forEach(function(a){a.type==="pkmsg"&&(q=!0),g.push({toJid:a.to,encTypeIndividualMixinArgs:{encType:a.type,encElementValue:a.ciphertext},encVersionFutureproofMixinArgs:{encV:parseInt(a.v,10)}})});c={appdataTo:d("WAGlobals").getMyUserJid(),toArgs:g};c={peerPeerFanout:c};var r=void 0;if(q){var s=(yield d("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo());s=s==null?void 0:s.identityKey;if(s==null){o.ERROR(j());return d("WAResultOrError").makeError("no-public-identity")}r={deviceIdentityElementValue:s}}s={appdataDeviceListCheck:e==="checkPhash"?"true":"false"};e={appdataId:b,peerPeerFanoutOrPeerSingleMixinGroupArgs:c,deviceIdentityMixinArgs:r,withDeviceListCheckMixinArgs:s};b=(yield d("WASmaxAppdataPublishPeerRPC").sendPeerRPC(e));switch(b.name){case"PeerResponseSuccess":r=(c=b.value.deviceListStaleMixin)==null?void 0:c.phash;if(r!=null&&a!=null&&r!==a){o.LOG(i(),a,r);d("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:d("WAOdsEnums").Entity.PHASH_MISMATCH,key:"appdata"});return d("WAResultOrError").makeResult({phashMismatch:!0})}else return d("WAResultOrError").makeResult({phashMismatch:!1});default:b.name;o.ERROR(h(),b.value.error);return d("WAResultOrError").makeError("ack-failure")}});return r.apply(this,arguments)}g.MAX_APPDATA_RECIPIENTS=p;g.sendAppDataToDevicesProtocol=a}),98);
__d("WASaveReceiptApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(a,b,c,d,e,f,g){"use strict";a=d("WADbTransactor").makeSignalTransactor({receipts:d("MAWTransactionMode").READWRITE},"saveReceipt",function(a){return function(b){return a.receipts.put({msgId:b.id.externalId.toString(),permittedIdentitiesPerDevice:b.permittedIdentitiesPerDevice,recipientDevices:b.recipientDevices,waMsgId:d("WAMsg").craftWAMsgIdString(b.id)}).then(function(){})}});g.saveReceipt=a}),98);
__d("WASendMsgUtilV2",["Promise","WADevicesState","WAErr","WAGenReportingMeta","WAGetDevices","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMsg","WAResultOrError","WASaveReceiptApi","WASendMsgInternal","WASentBytesCache","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";var h;function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error loading current device identity ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg failed to save sent bytes to cache: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error during get devices for users with missing icdc info: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["Triggering getDevices for users with missing icdc info."]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to calculate ICDC info for message with id ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message with no recipients, but it is a self thread"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message with no recipients"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["Trying to send a message that does not have a receipt in db"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["Failed to save receipt for message with error ",""]);q=function(){return a};return a}function r(){var a=babelHelpers.taggedTemplateLiteralLoose(["Error during get devices before sending: ",""]);r=function(){return a};return a}function s(a){return(h||(h=b("Promise"))).resolve()}function t(a,b){return d("WADevicesState").getDevicesState().waitForUserDevices(Array.from(new Set([a,d("WAGlobals").getMyUserJid()])),"GetDevicesBeforeSend: "+b)}function u(a,c){a=c.chatJid;var e=c.reason;return d("WAJids").switchOnChatJidType(a,{group:function(a){return s(a)},interopUser:function(a){return t(a,e)},lidUser:function(a){return t(a,e)},msgrUser:function(a){return t(a,e)},phoneUser:function(a){return t(a,e)}})["catch"](function(a){d("WALogger").ERROR(r(),a);return(h||(h=b("Promise"))).resolve()})}function v(a,b){return w.apply(this,arguments)}function w(){w=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){var c=a.messagePayload;a=a.loadThreadParticipants;var e={author:c.protocolMsgId.author,chat:c.protocolMsgId.chat,externalId:c.protocolMsgId.externalId},f=(yield d("WALoadReceiptApi").loadReceipt(e));if(f.success)return f;b==null?void 0:b.addPoint("get_devices_before_send_start");yield u(b,{chatJid:c.protocolMsgId.chat,reason:"prepareReceipt"});b==null?void 0:b.addPoint("get_devices_before_send_end");var g=(yield a(c.protocolMsgId.chat));f=(yield d("WAGlobals").getWaOneQueue().enqueue(function(a){a=a.cryptoManager;return a.storage.bulkLoadIdentities(g)},{flush:!1,afterInit:!0,operationType:"prepare_receipt_load_identities"}).then(function(a){var b=new Map();for(a of a){a[0];var c=a[1];for(c of c){var e=c[0],f=c[1];if(e===d("WAGlobals").getMyDeviceJid())continue;b.set(e,{pubKey:f})}}return b}));b=new Set();a={permittedIdentitiesPerDevice:f,recipientDevices:b,id:e};yield d("WASaveReceiptApi").saveReceipt(a)["catch"](function(a){d("WALogger").ERROR(q(),a);return d("WAResultOrError").makeError("missing-receipt")});return d("WAResultOrError").makeResult(a)});return w.apply(this,arguments)}function a(a,b,c){return x.apply(this,arguments)}function x(){x=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,c,e){a=c.messagePayload;var f=c.loadThreadParticipants,g=c.sendIdentity,i=g===void 0?!1:g;g=c.isInstamadillo;c=g===void 0?!1:g;g=(yield v({messagePayload:a,loadThreadParticipants:f},e));if(g.success===!1){d("WALogger").ERROR(p());return d("WAResultOrError").makeError({type:"missing-receipt"})}f=g.value;var q=a.frankingKey,r=a.frankingVersion,s=a.messageBytes,t=a.messageType,u=a.protocolMsgId;g=y(f.permittedIdentitiesPerDevice);var w=t.type==="text"&&t.invitedParticipantUserJid!=null?g.filter(function(a){return a.user===t.invitedParticipantUserJid||a.user===d("WAGlobals").getMyUserJid()}):g;e==null?void 0:e.addPoint("recipients-calculated",{"int":{recipientsCount:w.length},string:{msgType:t.type}});a=t.type==="text"&&t.invitedParticipantUserJid!=null?t.invitedParticipantUserJid:u.chat;f=u.chat===d("WAGlobals").getMyUserJid();if(w.length===0&&!f){d("WALogger").ERROR(o());return d("WAResultOrError").makeError({type:"no-recipients"})}else if(w.length===0&&f){d("WALogger").LOG(n());return d("WAResultOrError").makeResult({baseKey:null,reportingMeta:null,serverTs:d("WATimeUtils").unixTime()})}g=(yield d("WAGlobals").getWaOneQueue().enqueue(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a=a.cryptoManager;var b=(yield a.storage.calculateICDC(w.map(function(a){return a.user})));a=i?yield z(a):null;return{icdcInfoResult:b,deviceIdentity:a}});return function(b){return a.apply(this,arguments)}}(),{operationType:"calc_icdc",flush:!0,afterInit:!0}));f=g.icdcInfoResult;g=g.deviceIdentity;f.success===!1&&d("WALogger").ERROR(m(),u.externalId);f=f.success?f.value:{icdcInfo:[],usersWithMissingICDC:new Set()};var x=f.icdcInfo;f=f.usersWithMissingICDC;f.size>0&&(d("WALogger").LOG(l()),d("WAGetDevices").getDevices(null,{ignoreDhash:!0,reason:"missing-icdc-info",users:f})["catch"](function(a){d("WALogger").ERROR(k(),a)}));f=(yield t.isRevoked===!0?(h||(h=b("Promise"))).resolve(null):d("WAGenReportingMeta").genReportingMeta(s.bytes,q,r));return d("WASendMsgInternal").sendMessage({type:"chat",messageBytes:s,chat:a,deviceIdentity:g,messageType:t,protocolMsgId:u,externalId:u.externalId,icdcInfo:x,recipients:w,reportingMeta:f},e,c).then(function(a){if(a.success)return d("WASentBytesCache").sentBytesCache().saveSentBytes({ts:a.value.serverTs,frankingKey:q,frankingVersion:r,messageBytes:s,messageType:t,protocolMsgId:u,waMsgId:d("WAMsg").craftWAMsgIdString({author:u.author,chat:u.chat,externalId:u.externalId})})["catch"](function(a){d("WALogger").ERROR(j(),a)}).then(function(){return a});else return a})});return x.apply(this,arguments)}function y(a){var b=new Map();a.forEach(function(a,c){a=a.pubKey;var e=d("WAJids").extractUserJid(c);a={identity:a,jid:c};c=b.get(e)||[];c.push(a);b.set(e,c)});return Array.from(b,function(a){var b=a[0];a=a[1];return{devicesInfo:a,user:b}})}function z(a){return A.apply(this,arguments)}function A(){A=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){try{a=(yield a.storage.loadIdentities(d("WAGlobals").getMyUserJid()));a=a.get(d("WAGlobals").getMyDeviceJid());if(a!=null)return a;throw c("WAErr")("missing-identity")}catch(a){d("WALogger").ERROR(i(),a)}});return A.apply(this,arguments)}g.getDevicesBeforeSend=u;g.sendChatMessage=a}),98);
__d("WASetClockSkewApi",["WASetMetaApi"],(function(a,b,c,d,e,f,g){"use strict";a=function(a){a=a.clockSkew;return d("WASetMetaApi").setMeta({clockSkew:a})};g.setClockSkew=a}),98);
__d("WASendPing",["WAComms","WALogger","WASetClockSkewApi","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["sendPing: sending"]);h=function(){return a};return a}function a(){d("WALogger").LOG(h()),d("WAComms").sendPing()}function c(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){a=b.clockSkew;d("WATimeUtils").setClockSkew(a);yield d("WASetClockSkewApi").setClockSkew({clockSkew:a})});return i.apply(this,arguments)}g.sendPing=a;g.updateClockSkew=c}),98);
__d("WASmaxInAbPropsIQErrorBadRequestMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","bad-request");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",400);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorBadRequestMixin=a}),98);
__d("WASmaxInAbPropsIQErrorFeatureNotImplementedMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","feature-not-implemented");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",501);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorFeatureNotImplementedMixin=a}),98);
__d("WASmaxInAbPropsIQErrorBadRequestOrFeatureNotImplementedMixinGroup",["WAResultOrError","WASmaxInAbPropsIQErrorBadRequestMixin","WASmaxInAbPropsIQErrorFeatureNotImplementedMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInAbPropsIQErrorBadRequestMixin").parseIQErrorBadRequestMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"IQErrorBadRequest",value:b.value});var c=d("WASmaxInAbPropsIQErrorFeatureNotImplementedMixin").parseIQErrorFeatureNotImplementedMixin(a);return c.success?d("WAResultOrError").makeResult({name:"IQErrorFeatureNotImplemented",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["IQErrorBadRequest","IQErrorFeatureNotImplemented"],[b,c])}g.parseIQErrorBadRequestOrFeatureNotImplementedMixinGroup=a}),98);
__d("WASmaxInAbPropsIQErrorResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","error");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQErrorResponseMixin=a}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry",["WAResultOrError","WASmaxInAbPropsIQErrorBadRequestOrFeatureNotImplementedMixinGroup","WASmaxInAbPropsIQErrorResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;a=d("WASmaxInAbPropsIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxInAbPropsIQErrorBadRequestOrFeatureNotImplementedMixinGroup").parseIQErrorBadRequestOrFeatureNotImplementedMixinGroup(c.value);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({},a.value,{errorIQErrorBadRequestOrFeatureNotImplementedMixinGroup:b.value}))}g.parseGetExperimentConfigResponseErrorNoRetry=a}),98);
__d("WASmaxInAbPropsIQErrorInternalServerErrorMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"error");if(!b.success)return b;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"text","internal-server-error");if(!b.success)return b;a=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrInt,a,"code",500);return!a.success?a:d("WAResultOrError").makeResult({text:b.value,code:a.value})}g.parseIQErrorInternalServerErrorMixin=a}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseErrorRetry",["WAResultOrError","WASmaxInAbPropsIQErrorInternalServerErrorMixin","WASmaxInAbPropsIQErrorResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"error");if(!c.success)return c;c=d("WASmaxInAbPropsIQErrorInternalServerErrorMixin").parseIQErrorInternalServerErrorMixin(c.value);if(!c.success)return c;a=d("WASmaxInAbPropsIQErrorResponseMixin").parseIQErrorResponseMixin(a,b);return!a.success?a:d("WAResultOrError").makeResult(babelHelpers["extends"]({errorIQErrorInternalServerErrorMixin:c.value},a.value))}g.parseGetExperimentConfigResponseErrorRetry=a}),98);
__d("WASmaxInAbPropsExperimentConfigMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"prop");if(!b.success)return b;b=d("WASmaxParseUtils").attrIntRange(a,"config_code",1,void 0);if(!b.success)return b;var c=d("WASmaxParseUtils").attrString(a,"config_value");if(!c.success)return c;a=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,a,"config_expo_key",0,void 0);return!a.success?a:d("WAResultOrError").makeResult({configCode:b.value,configValue:c.value,configExpoKey:a.value})}g.parseExperimentConfigMixin=a}),98);
__d("WASmaxInAbPropsSamplingConfigMixin",["WAResultOrError","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxParseUtils").assertTag(a,"prop");if(!b.success)return b;b=d("WASmaxParseUtils").attrIntRange(a,"event_code",1,void 0);if(!b.success)return b;a=d("WASmaxParseUtils").attrIntRange(a,"sampling_weight",-1e4,1e4);return!a.success?a:d("WAResultOrError").makeResult({eventCode:b.value,samplingWeight:a.value})}g.parseSamplingConfigMixin=a}),98);
__d("WASmaxInAbPropsExperimentOrSamplingConfigMixinGroup",["WAResultOrError","WASmaxInAbPropsExperimentConfigMixin","WASmaxInAbPropsSamplingConfigMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a){var b=d("WASmaxInAbPropsExperimentConfigMixin").parseExperimentConfigMixin(a);if(b.success)return d("WAResultOrError").makeResult({name:"ExperimentConfig",value:b.value});var c=d("WASmaxInAbPropsSamplingConfigMixin").parseSamplingConfigMixin(a);return c.success?d("WAResultOrError").makeResult({name:"SamplingConfig",value:c.value}):d("WASmaxParseUtils").errorMixinDisjunction(a,["ExperimentConfig","SamplingConfig"],[b,c])}g.parseExperimentOrSamplingConfigMixinGroup=a}),98);
__d("WASmaxInAbPropsIQResultResponseMixin",["WAResultOrError","WASmaxParseReference","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["id"]);if(!c.success)return c;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"id",c.value);if(!c.success)return c;c=d("WASmaxParseReference").attrStringFromReference(b,["to"]);if(!c.success)return c;b=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"from",c.value);if(!b.success)return b;c=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,a,"type","result");return!c.success?c:d("WAResultOrError").makeResult({type:c.value})}g.parseIQResultResponseMixin=a}),98);
__d("WASmaxInAbPropsGetExperimentConfigResponseSuccess",["WAResultOrError","WASmaxInAbPropsExperimentOrSamplingConfigMixinGroup","WASmaxInAbPropsIQResultResponseMixin","WASmaxParseUtils"],(function(a,b,c,d,e,f,g){function h(a){var b=d("WASmaxParseUtils").assertTag(a,"prop");if(!b.success)return b;b=d("WASmaxInAbPropsExperimentOrSamplingConfigMixinGroup").parseExperimentOrSamplingConfigMixinGroup(a);return!b.success?b:d("WAResultOrError").makeResult({experimentOrSamplingConfigMixinGroup:b.value})}function i(a){var b=d("WASmaxParseUtils").assertTag(a,"erid");if(!b.success)return b;b=d("WASmaxParseUtils").contentBytesRange(a,1,100);return!b.success?b:d("WAResultOrError").makeResult({elementValue:b.value})}function a(a,b){var c=d("WASmaxParseUtils").assertTag(a,"iq");if(!c.success)return c;c=d("WASmaxParseUtils").flattenedChildWithTag(a,"props");if(!c.success)return c;var e=d("WASmaxParseUtils").optionalChildWithTag(a,"erid",i);if(!e.success)return e;var f=d("WASmaxParseUtils").literal(d("WASmaxParseUtils").attrString,c.value,"protocol","1");if(!f.success)return f;var g=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrString,c.value,"ab_key");if(!g.success)return g;var j=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrString,c.value,"hash");if(!j.success)return j;var k=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,c.value,"refresh",0,void 0);if(!k.success)return k;var l=d("WASmaxParseUtils").optional(d("WASmaxParseUtils").attrIntRange,c.value,"refresh_id",0,void 0);if(!l.success)return l;a=d("WASmaxInAbPropsIQResultResponseMixin").parseIQResultResponseMixin(a,b);if(!a.success)return a;b=d("WASmaxParseUtils").mapChildrenWithTag(c.value,"prop",0,Infinity,h);return!b.success?b:d("WAResultOrError").makeResult(babelHelpers["extends"]({propsProtocol:f.value,propsAbKey:g.value,propsHash:j.value,propsRefresh:k.value,propsRefreshId:l.value},a.value,{erid:e.value,propsProp:b.value}))}g.parseGetExperimentConfigResponseSuccessPropsProp=h;g.parseGetExperimentConfigResponseSuccessErid=i;g.parseGetExperimentConfigResponseSuccess=a}),98);
__d("WASmaxOutAbPropsBaseIQGetRequestMixin",["WASmaxJsx","WASmaxMixins","WAWap"],(function(a,b,c,d,e,f,g){function h(){var a=d("WASmaxJsx").smax("iq",{id:d("WAWap").generateId(),type:"get"});return a}function a(a){var b=h();return d("WASmaxMixins").mergeStanzas(a,b)}g.mergeBaseIQGetRequestMixin=a}),98);
__d("WASmaxOutAbPropsGetExperimentConfigRequest",["WASmaxAttrs","WASmaxJsx","WASmaxOutAbPropsBaseIQGetRequestMixin","WAWap"],(function(a,b,c,d,e,f,g){function a(a){a=a.propsHash;a=d("WASmaxOutAbPropsBaseIQGetRequestMixin").mergeBaseIQGetRequestMixin(d("WASmaxJsx").smax("iq",{xmlns:"abt",to:d("WAWap").S_WHATSAPP_NET},d("WASmaxJsx").smax("props",{protocol:"1",hash:d("WASmaxAttrs").OPTIONAL(d("WAWap").CUSTOM_STRING,a)})));return a}g.makeGetExperimentConfigRequest=a}),98);
__d("WASmaxAbPropsGetExperimentConfigRPC",["WAComms","WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry","WASmaxInAbPropsGetExperimentConfigResponseErrorRetry","WASmaxInAbPropsGetExperimentConfigResponseSuccess","WASmaxOutAbPropsGetExperimentConfigRequest","WASmaxParsingFailure","WASmaxRpcUtils","regeneratorRuntime"],(function(a,b,c,d,e,f,g){function a(a,c){var e,f,g,h,i;return b("regeneratorRuntime").async(function(j){while(1)switch(j.prev=j.next){case 0:e=d("WASmaxOutAbPropsGetExperimentConfigRequest").makeGetExperimentConfigRequest(a);j.next=3;return b("regeneratorRuntime").awrap(d("WAComms").sendSmaxStanza(e,c));case 3:f=j.sent;g=d("WASmaxInAbPropsGetExperimentConfigResponseSuccess").parseGetExperimentConfigResponseSuccess(f,e);if(!g.success){j.next=7;break}return j.abrupt("return",{name:"GetExperimentConfigResponseSuccess",value:g.value});case 7:h=d("WASmaxInAbPropsGetExperimentConfigResponseErrorNoRetry").parseGetExperimentConfigResponseErrorNoRetry(f,e);if(!h.success){j.next=10;break}return j.abrupt("return",{name:"GetExperimentConfigResponseErrorNoRetry",value:h.value});case 10:i=d("WASmaxInAbPropsGetExperimentConfigResponseErrorRetry").parseGetExperimentConfigResponseErrorRetry(f,e);if(!i.success){j.next=13;break}return j.abrupt("return",{name:"GetExperimentConfigResponseErrorRetry",value:i.value});case 13:throw new(d("WASmaxParsingFailure").SmaxParsingFailure)(d("WASmaxRpcUtils").errorMessageRpcParsing("GetExperimentConfig",{Success:g,ErrorNoRetry:h,ErrorRetry:i}));case 14:case"end":return j.stop()}},null,this)}g.sendGetExperimentConfigRPC=a}),98);
__d("WAGetAbPropsProtocol",["WALogger","WAResultOrError","WASmaxAbPropsGetExperimentConfigRPC","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["getAbPropsProtocol failed ",""]);h=function(){return a};return a}function a(a){var c,e,f,g,j,k,l,m,n,o,p;return b("regeneratorRuntime").async(function(q){while(1)switch(q.prev=q.next){case 0:q.next=2;return b("regeneratorRuntime").awrap(d("WASmaxAbPropsGetExperimentConfigRPC").sendGetExperimentConfigRPC({propsHash:a}));case 2:c=q.sent;if(!(c.name==="GetExperimentConfigResponseSuccess")){q.next=7;break}e=c.value,f=e.propsAbKey,g=e.propsHash,j=e.propsRefresh,k=e.propsRefreshId,l=e.propsProp,m=e.erid;n=i(l),o=n.newProps,p=n.samplingConfigs;return q.abrupt("return",d("WAResultOrError").makeResult({abKey:f,hash:g,refresh:j,refreshId:k,props:o,samplingConfigs:p,erid:m==null?void 0:m.elementValue}));case 7:d("WALogger").WARN(h(),c.value);return q.abrupt("return",d("WAResultOrError").makeError());case 9:case"end":return q.stop()}},null,this)}function i(a){var b=[],c=[];a.forEach(function(a){a=a.experimentOrSamplingConfigMixinGroup;if(a.name==="ExperimentConfig"){var d;b.push({configCode:a.value.configCode,configValue:a.value.configValue,configExpoKey:(d=a.value.configExpoKey)==null?void 0:d.toString()})}else a.name==="SamplingConfig"&&c.push({eventCode:a.value.eventCode,samplingWeight:a.value.samplingWeight})});return{newProps:b,samplingConfigs:c}}g.getAbPropsProtocol=a}),98);
__d("WAAbPropsSync",["WAAbProps","WAAbPropsHelpers","WAGetAbPropsProtocol","WALogger","WAPromiseManagement","WAResultOrError","WATimeUtils","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["WAAbProps.update: updating ab configs"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["WAAbProps.update: detected no hash"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["syncAbProps: detected no hash"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["fetchAbProps failed"]);k=function(){return a};return a}c=d("WAPromiseManagement").cacheWhilePending(function(){return"abProps"},a);function a(a){var b=a.sendHash;b=b===void 0?!0:b;var c=a.eventFlow;c==null?void 0:c.addPoint("sync_ab_props",{bool:{sendHash:b}});return b==null||b===!1?l(null,c):d("WAAbProps").getHash().then(function(a){return l(a,c)})}e=a;function l(a,c){var e,f,g,h,i,l,n,o,p;return b("regeneratorRuntime").async(function(q){while(1)switch(q.prev=q.next){case 0:c==null?void 0:c.addPoint("fetch_ab_props");q.next=3;return b("regeneratorRuntime").awrap(d("WAGetAbPropsProtocol").getAbPropsProtocol(a));case 3:e=q.sent;if(e.success){q.next=8;break}d("WALogger").ERROR(k());q.next=15;break;case 8:f=e.value,g=f.abKey,h=f.hash,i=f.refresh,l=f.props;n=d("WAAbPropsHelpers").parseAbProps(d("WAAbProps").getConfig(),l);c==null?void 0:c.addPoint("save_ab_props");q.next=13;return b("regeneratorRuntime").awrap(m(g,h,i,n));case 13:o=q.sent,o.success===!1&&(o.error,d("WALogger").LOG(j()));case 15:q.next=17;return b("regeneratorRuntime").awrap(d("WAAbProps").getRefreshSecs());case 17:p=q.sent;return q.abrupt("return",{seconds:p});case 19:case"end":return q.stop()}},null,this)}function m(a,c,e,f){var g,j,k,l,m,n,o,p,q,r,s,t,u;return b("regeneratorRuntime").async(function(v){while(1)switch(v.prev=v.next){case 0:v.next=2;return b("regeneratorRuntime").awrap(d("WAAbProps").getAbProps());case 2:k=v.sent;l={abKey:(g=a)!=null?g:k.abKey,hash:(j=c)!=null?j:k.hash,refresh:d("WAAbPropsHelpers").maybeUpdateRefresh(e),lastSyncTime:d("WATimeUtils").unixTime(),propValues:k.propValues,propExpoKeys:k.propExpoKeys,internalExpoKeys:k.internalExpoKeys,expoKeyStr:k.expoKeyStr};if(!(c==null)){v.next=9;break}v.next=7;return b("regeneratorRuntime").awrap(d("WAAbProps").setAbProps(l));case 7:d("WALogger").LOG(i());return v.abrupt("return",d("WAResultOrError").makeError("noHash"));case 9:d("WALogger").LOG(h());m=f.values,n=f.expoKeys;o=d("WAAbPropsHelpers").maybeUpdatePropValues(m,k.propValues,d("WAAbProps").getConfig());p=d("WAAbPropsHelpers").maybeUpdateExpoKeys(n,k.propExpoKeys,d("WAAbProps").getConfig()),q=p.propExpoKeys,r=p.expoKeysToDelete;u=d("WAAbPropsHelpers").maybeUpdateInternalExpoKeys(r,k.internalExpoKeys);u!=null&&(s=u.internalExpoKeys,t=u.expoKeyStr);v.next=17;return b("regeneratorRuntime").awrap(d("WAAbProps").setAbProps(babelHelpers["extends"]({},l,{propValues:o,propExpoKeys:q,internalExpoKeys:s,expoKeyStr:t})));case 17:return v.abrupt("return",d("WAResultOrError").makeResult());case 18:case"end":return v.stop()}},null,this)}g.syncAbProps=c;g.syncAbPropsDebug=e}),98);
__d("WASyncAbProps",["WAAbPropsSync","WALogger","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["Syncing ABProps"]);h=function(){return a};return a}function a(a,b){return i.apply(this,arguments)}function i(){i=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b){b=b.sendHash;d("WALogger").LOG(h());yield d("WAAbPropsSync").syncAbProps({sendHash:b,eventFlow:(b=a)!=null?b:void 0})});return i.apply(this,arguments)}g.syncAbProps=a}),98);
__d("WAHttpResumeCheck",["WALogger","WAMediaUtils","WAResultOrError","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: fail to parse request body ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: resume is NaN: ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: object_id is missing"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: direct_path is missing"]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: response status ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpResumeCheck: fail to initiate fetch ",""]);m=function(){return a};return a}function a(a){var c,e,f;return b("regeneratorRuntime").async(function(g){while(1)switch(g.prev=g.next){case 0:g.prev=0;g.next=3;return b("regeneratorRuntime").awrap(fetch(a,{method:"POST",mode:"cors",cache:"no-cache",headers:{"Content-Type":"text/plain"}}));case 3:c=g.sent;g.next=10;break;case 6:g.prev=6;g.t0=g["catch"](0);d("WALogger").ERROR(m(),g.t0);throw g.t0;case 10:e=c,f=e.status;d("WALogger").LOG(l(),f);g.t1=f;g.next=g.t1===200?15:g.t1===404?16:g.t1===408?17:g.t1===429?18:g.t1===507?18:19;break;case 15:return g.abrupt("return",c.json().then(function(a){var b=a.resume,c=a.direct_path;a=a.object_id;if(b==="complete"){if(c==null){d("WALogger").ERROR(k());return d("WAResultOrError").makeResult({type:"media-not-found"})}if(a==null){d("WALogger").ERROR(j());return d("WAResultOrError").makeResult({type:"media-not-found"})}return d("WAResultOrError").makeResult({type:"media-found",directPath:d("WAMediaUtils").castToDirectPath(c),objectId:d("WAMediaUtils").stringToDeliveryObjectId(a)})}c=parseInt(b,10);if(c===0)return d("WAResultOrError").makeResult({type:"media-not-found"});if(Number.isNaN(c)){d("WALogger").ERROR(i(),b);return d("WAResultOrError").makeResult({type:"media-not-found"})}return d("WAResultOrError").makeResult({type:"media-partial-found",resumeFromBytes:c})})["catch"](function(a){d("WALogger").ERROR(h(),a);return d("WAResultOrError").makeError("body-network-error")}));case 16:return g.abrupt("return",d("WAResultOrError").makeResult({type:"media-not-found"}));case 17:return g.abrupt("return",d("WAResultOrError").makeError("server-timeout"));case 18:return g.abrupt("return",d("WAResultOrError").makeError("upload-throttled"));case 19:if(!(f>=400&&f<500)){g.next=21;break}return g.abrupt("return",d("WAResultOrError").makeError("request-error"));case 21:return g.abrupt("return",d("WAResultOrError").makeError("unspecified-http-error"));case 22:case"end":return g.stop()}},null,this,[[0,6]])}g.httpResumeCheck=a}),98);
__d("WACheckCiphertextInServer",["WAHttpResumeCheck","WAMediaUrl","WAResultOrError","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,c,e,f){return f.run(function(f,g){var h,i,j;return b("regeneratorRuntime").async(function(k){while(1)switch(k.prev=k.next){case 0:h=d("WAMediaUrl").buildUploadUrl(a,e,c,f.domain,g,!0);k.next=3;return b("regeneratorRuntime").awrap(d("WAHttpResumeCheck").httpResumeCheck(h));case 3:i=k.sent;if(!i.success){k.next=8;break}return k.abrupt("return",d("WAResultOrError").makeResult(i));case 8:j=i.error;k.t0=j;k.next=k.t0==="server-timeout"?12:k.t0==="unspecified-http-error"?12:13;break;case 12:return k.abrupt("return",d("WAResultOrError").makeError({progressMade:!0}));case 13:return k.abrupt("return",d("WAResultOrError").makeResult(d("WAResultOrError").makeError(j)));case 14:case"end":return k.stop()}},null,this)}).then(function(a){return(a=a)!=null?a:d("WAResultOrError").makeError("max-attempts-exceeded")})}g.checkCiphertextInServer=a}),98);
__d("WACreateRetrier",["WAComms","WAGetMediaRoute","WAMediaOperationsRetrier","WAResultOrError","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function a(a,c){var e,f,g,h,i,j;return b("regeneratorRuntime").async(function(k){while(1)switch(k.prev=k.next){case 0:c==null?void 0:c.addPoint("get_media_route_start");k.next=3;return b("regeneratorRuntime").awrap(d("WAGetMediaRoute").getMediaRoute({operation:"upload",serverMediaType:a},c));case 3:e=k.sent;c==null?void 0:c.addPoint("get_media_route_finish");if(e.success){k.next=7;break}return k.abrupt("return",e);case 7:f=e.value,g=f.selectedHost,h=f.fallbackHost,i=f.authToken;j=new(d("WAMediaOperationsRetrier").MediaOperationsRetrier)("upload",{host:{domain:g.domain,"class":g["class"]},fallbackHost:h&&{domain:h.domain,"class":h["class"]},authToken:i,timeElapsed:null},d("WAComms").waitForConnection);return k.abrupt("return",d("WAResultOrError").makeResult(j));case 10:case"end":return k.stop()}},null,this)}g.createUploadRetrier=a}),98);
__d("WAHttpRegularUploadMedia",["WAErr","WALogger","WAMediaUtils","WAResultOrError","regeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpRegularUploadMedia: fail to parse request body ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["Fetch Media HTTP status ",""]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["HttpRegularUploadMedia: fail to initiate fetch ",""]);j=function(){return a};return a}function a(a,e){var f,g,k;return b("regeneratorRuntime").async(function(l){while(1)switch(l.prev=l.next){case 0:l.prev=0;l.next=3;return b("regeneratorRuntime").awrap(fetch(a,{method:"POST",mode:"cors",cache:"no-store",headers:{"Content-Type":"text/plain"},body:new Blob([e])}));case 3:f=l.sent;l.next=10;break;case 6:l.prev=6;l.t0=l["catch"](0);d("WALogger").ERROR(j(),l.t0);throw l.t0;case 10:g=f,k=g.status;d("WALogger").LOG(i(),k);l.t1=k;l.next=l.t1===200?15:l.t1===408?16:l.t1===413?17:l.t1===415?18:l.t1===429?19:l.t1===507?19:20;break;case 15:return l.abrupt("return",f.json().then(function(a){if(!Object.prototype.hasOwnProperty.call(a,"direct_path"))throw c("WAErr")("direct_path not available in wa upload http response");if(typeof a.direct_path!=="string")throw c("WAErr")('directPath: "'+a.direct_path+'" is not a string');if(a.object_id&&typeof a.object_id!=="string")throw c("WAErr")('objectId: "'+a.object_id+'" is not a string');if(a.handle&&typeof a.handle!=="string")throw c("WAErr")('handle: "'+a.handle+'" is not a string');a={directPath:d("WAMediaUtils").castToDirectPath(a.direct_path),objectId:a.object_id,handle:a.handle};return d("WAResultOrError").makeResult(a)})["catch"](function(a){d("WALogger").ERROR(h(),a);return d("WAResultOrError").makeError("body-network-error")}));case 16:return l.abrupt("return",d("WAResultOrError").makeError("server-timeout"));case 17:return l.abrupt("return",d("WAResultOrError").makeError("payload-too-large"));case 18:return l.abrupt("return",d("WAResultOrError").makeError("invalid-media"));case 19:return l.abrupt("return",d("WAResultOrError").makeError("upload-throttled"));case 20:if(!(k>=400&&k<500)){l.next=22;break}return l.abrupt("return",d("WAResultOrError").makeError("request-error"));case 22:return l.abrupt("return",d("WAResultOrError").makeError("unspecified-http-error"));case 23:case"end":return l.stop()}},null,this,[[0,6]])}g.httpRegularUploadMedia=a}),98);
__d("WAEncryptAndUploadPlaintext",["WABase64","WAGlobals","WAHttpRegularUploadMedia","WAHttpResumeCheck","WALogger","WAMediaCrypto","WAMediaUrl","WAMediaUtils","WAProgressiveJpegGetPJpegDetails","WAResultOrError","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: upload success "," ",""]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext given up"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext error: ",""]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext error: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: start upload media to ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: error during retrier ",""]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: Found valid progressiveJpeg details. Adding to media entry."]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: Created invalid progressiveJpeg details during encrypt and upload: ",""]);o=function(){return a};return a}function a(a){return p.apply(this,arguments)}function p(){p=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){var c=a.mediaTypeDetails,e=a.plaintextHash,f=a.plaintext,g=a.mediaKey,p=a.mediaKeyTimestamp,q=a.uploadToken,r=a.size,s=a.uploadRetrier,t=a.updateMediaEntry,u=a.mediaUploadQplFlow,v=a.filename,w=a.fromOffset,x=w===void 0?0:w;w=a.getDownloadableThumbnailForMedia;var y,z,A;if(c.type==="preview"){a=(yield d("WAMediaCrypto").computeMediaKeysForPreview(g));y=a.iv;z=a.cipherKey;a=a.hmacKey;A="preview"}else{var B=(yield d("WAMediaCrypto").computeMediaKeys(g,c.mediaType));y=B.iv;z=B.cipherKey;a=B.hmacKey;A=c.mediaType}B=(yield d("WAMediaCrypto").encryptAndHmac(z,y,a,f,A));var C=B.ciphertext,D=B.ciphertextHash;c=B.sidecar;z=B.ivCiphertextHmac;y=null;if(A==="image"){u==null?void 0:u.addPoint("get_progressive_jpeg_details_start");B=(yield d("WAProgressiveJpegGetPJpegDetails").getProgressiveJpegDetails(new Uint8Array(yield d("WAMediaUtils").blobToArrayBuffer(f)),z,a));f=d("WAProgressiveJpegGetPJpegDetails").isValidProgressiveJpegDetails(B);f.success===!1?(d("WALogger").ERROR(o(),f.error),u==null?void 0:u.addPoint(f.error)):f.value===!0&&d("WAGlobals").getConfig().isProgressiveJpegSendEnabled()&&(d("WALogger").LOG(n()),y=B,u==null?void 0:u.addPoint("get_progressive_jpeg_details_end"))}z={fileSha256:d("WABase64").decodeB64UrlSafe(e),fileEncSha256:D,mediaKey:g,mediaKeyTimestamp:p,serverMediaType:A,uploadToken:q,sidecar:c,filename:v,progressiveJpegDetails:y,size:r,lastDownloadAttemptTimestamp:void 0,directPath:void 0};var E;u==null?void 0:u.addPoint("update_media_entry_start");yield t(z);u==null?void 0:u.addPoint("update_media_entry_end");a=(yield s.run(function(){var a=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a,b,c){a=a.domain;var e=x;if(c>0)try{u==null?void 0:u.addPoint("resume_check_start");var f=d("WAMediaUrl").buildUploadUrl(A,q,D,a,b,!0);f=(yield d("WAHttpResumeCheck").httpResumeCheck(f));if(f.success){u==null?void 0:u.addPoint("resume_check_end");var g=f.value;if(g.type==="media-found"){u==null?void 0:u.addAnnotations({bool:{existingMediaFound:!0}});return d("WAResultOrError").makeResult(d("WAResultOrError").makeResult({directPath:g.directPath,objectId:null,handle:null}))}g.type==="media-partial-found"&&(e=g.resumeFromBytes)}u==null?void 0:u.addPoint("resume_check_fail",{string:{resume_check_error:f.error}})}catch(a){u==null?void 0:u.addPoint("resume_check_fail",{string:{resume_check_error:a.message}}),d("WALogger").ERROR(m(),a)}e>0&&e<C.byteLength?(u==null?void 0:u.addAnnotations({"int":{fromOffset:e},bool:{continuedFromOffset:!0}}),E=C.subarray(e)):E=C;g=d("WAMediaUrl").buildUploadUrl(A,q,D,a,b,!1,e);d("WALogger").LOG(l(),g);u==null?void 0:u.addPoint("http_upload_start");return d("WAHttpRegularUploadMedia").httpRegularUploadMedia(g,E).then(function(a){if(a.success){u==null?void 0:u.addPoint("http_upload_end",{"int":{byteLength:E.byteLength,attempt:c}});return d("WAResultOrError").makeResult(a)}else{a=a.error;u==null?void 0:u.addPoint("http_upload_fail",{string:{http_upload_error:a}});d("WALogger").LOG(k(),a);switch(a){case"server-timeout":case"unspecified-http-error":return d("WAResultOrError").makeError({progressMade:!0});default:return d("WAResultOrError").makeResult(d("WAResultOrError").makeError(a))}}})["catch"](function(a){u==null?void 0:u.addPoint("http_upload_fail",{string:{http_upload_error:a.message}});d("WALogger").ERROR(j(),a);return d("WAResultOrError").makeError({progressMade:!1})})});return function(b,c,d){return a.apply(this,arguments)}}()));if(a==null){d("WALogger").WARN(i());u==null?void 0:u.endFail("maxAttemptsExceeded");return d("WAResultOrError").makeError("max-attempts-exceeded")}if(a.success===!1){u==null?void 0:u.endFail(a.error);return a}f=a.value;B=f.directPath;g=f.objectId;p=f.handle;try{u==null?void 0:u.addPoint("persist_downloadable_thumbnail_start");c=(yield w(e));z=babelHelpers["extends"]({},z,{directPath:B,downloadableThumbnail:c,handle:p,objectId:g});yield t(z);u==null?void 0:u.addPoint("persist_downloadable_thumbnail_end")}catch(a){u==null?void 0:u.addPoint("persist_downloadable_thumbnail_fail",{string:{persist_downloadable_thumbnail_error:a.message}})}d("WALogger").LOG(h(),{directPath:B},{objectId:g});u==null?void 0:u.endSuccess();return d("WAResultOrError").makeResult(z)});return p.apply(this,arguments)}g.encryptAndUploadPlaintext=a}),98);
__d("WAIsMediaKeyReusable",["WATimeUtils"],(function(a,b,c,d,e,f,g){"use strict";var h=2*d("WATimeUtils").DAY_SECONDS;function a(a){var b=Math.floor(Math.random()*d("WATimeUtils").DAY_SECONDS);return a!=null&&d("WATimeUtils").happenedWithin(a,h+b)}g.MMS_MEDIA_KEY_TTL=h;g.isMediaKeyReusable=a}),98);
__d("WAFindReusableMediaEntry",["WAIsMediaKeyReusable","WAMediaUtils"],(function(a,b,c,d,e,f,g){"use strict";function a(a,b){if(a==null)return null;b=b.get(a);if(b==null)return null;a=d("WAMediaUtils").decodeMediaEntryData(b);b=a.fileEncSha256;var c=a.mediaKey,e=a.mediaKeyTimestamp,f=a.uploadToken;a=babelHelpers.objectWithoutPropertiesLoose(a,["fileEncSha256","mediaKey","mediaKeyTimestamp","uploadToken"]);return c!=null&&f!=null&&b!=null&&e!=null&&d("WAIsMediaKeyReusable").isMediaKeyReusable(e)?babelHelpers["extends"]({},a,{fileEncSha256:b,mediaKey:c,mediaKeyTimestamp:e,uploadToken:f}):null}g.findReusableMediaEntryForArmadillo=a}),98);
__d("WAUploadMedia",["WABase64","WABulkPutMediaKeysApi","WACheckCiphertextInServer","WACreateRetrier","WAEncryptAndUploadPlaintext","WAFindReusableMediaEntry","WAGlobals","WAHashUtils","WALogger","WAMediaUtils","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(a,b,c,d,e,f,g){"use strict";function h(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: no plaintext"]);h=function(){return a};return a}function i(){var a=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: media is not on the server, start uploading"]);i=function(){return a};return a}function j(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: no plaintext"]);j=function(){return a};return a}function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: media is partially on the server, start uploading from byteOffset ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: media is on the server"]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: resume/exist check exhausted available retries"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: async upload"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["encryptAndUploadPlaintext: no plaintext"]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: no media entry found, need to upload media"]);p=function(){return a};return a}function q(){var a=babelHelpers.taggedTemplateLiteralLoose(["uploadMedia: fail to gather media routes"]);q=function(){return a};return a}function a(a){return r.apply(this,arguments)}function r(){r=b("asyncToGeneratorRuntime").asyncToGenerator(function*(a){a.chatJid;var b=a.filename,c=a.hash,e=a.mediaTypeDetails,f=a.protocolMsgId,g=a.size,r=a.uploadMediaMetric,t=a.getMediaKnownEntries,u=a.getMediaPlaintext,v=a.updateMediaEntryForMsg,w=a.updateMediaEntryForOptimisticUpload;a=a.getDownloadableThumbnailForMedia;var x;e.type==="regular"?x=e.mediaType:(x="preview",r==null?void 0:r.addAnnotations({string:{fullSizeMediaType:e.messageType}}));r==null?void 0:r.addPoint("upload_retrier_start");var y=(yield d("WACreateRetrier").createUploadRetrier(x,r));if(!y.success){d("WALogger").WARN(q());r==null?void 0:r.endFail("failToGatherMediaRoutes");return y}y=y.value;r==null?void 0:r.addPoint("update_media_entry_fn_start");v=s(f,c,v,w);r==null?void 0:r.addPoint("update_media_entry_fn_end");w=(yield t(c));t=d("WAFindReusableMediaEntry").findReusableMediaEntryForArmadillo(f,w);if(t==null){d("WALogger").LOG(p());f=d("WAMediaUtils").createMediaKey();w=d("WAMediaUtils").createUploadToken();var z=d("WATimeUtils").unixTime();r==null?void 0:r.addPoint("get_media_plaintext_start");var A=(yield u(c));if(A==null){d("WALogger").ERROR(o());r==null?void 0:r.endFail("missingPlaintext");return d("WAResultOrError").makeError("no-plaintext")}r==null?void 0:r.addPoint("encrypt_and_upload_plaintext_start");return d("WAEncryptAndUploadPlaintext").encryptAndUploadPlaintext({size:g,filename:b,mediaKey:f,mediaKeyTimestamp:z,mediaTypeDetails:e,mediaUploadQplFlow:r,plaintext:A,plaintextHash:c,updateMediaEntry:v,uploadRetrier:y,uploadToken:w,getDownloadableThumbnailForMedia:a})}f=t.directPath;z=t.downloadableThumbnail;A=t.fileEncSha256;w=t.fileSha256;var B=t.mediaKey,C=t.mediaKeyTimestamp,D=t.objectId;t=t.uploadToken;z={directPath:f,downloadableThumbnail:z,fileEncSha256:A,filename:b,fileSha256:w||d("WABase64").decodeB64UrlSafe(c),mediaKey:B,mediaKeyTimestamp:C,objectId:D,serverMediaType:x,size:g,uploadToken:t};if(f!=null){d("WALogger").LOG(n());yield v(z);r==null?void 0:r.endSuccess({bool:{reused_media_entry:!0}});return d("WAResultOrError").makeResult(z)}r==null?void 0:r.addPoint("check_ciphertext_in_server_start");w=(yield d("WACheckCiphertextInServer").checkCiphertextInServer(x,A,t,y));if(!w.success){d("WALogger").WARN(m());r==null?void 0:r.endFail("failToUpload");return w}D=w.value;if(D.type==="media-found"){d("WALogger").LOG(l());r==null?void 0:r.addAnnotations({bool:{existingMediaFound:!0}});f=babelHelpers["extends"]({},z,{directPath:D.directPath,objectId:D.objectId});yield v(f);r==null?void 0:r.endSuccess({bool:{reused_media_entry:!0}});return d("WAResultOrError").makeResult(f)}else if(D.type==="media-partial-found"){d("WALogger").LOG(k(),D.resumeFromBytes);x=D.resumeFromBytes;r==null?void 0:r.addPoint("get_media_plaintext_start");A=(yield u(c));if(A==null){d("WALogger").ERROR(j());r==null?void 0:r.endFail("missingPlaintext");return d("WAResultOrError").makeError("no-plaintext")}r==null?void 0:r.addPoint("encrypt_and_upload_plaintext_start");return d("WAEncryptAndUploadPlaintext").encryptAndUploadPlaintext({size:g,filename:b,fromOffset:x,mediaKey:B,mediaKeyTimestamp:C,mediaTypeDetails:e,mediaUploadQplFlow:r,plaintext:A,plaintextHash:c,updateMediaEntry:v,uploadRetrier:y,uploadToken:t,getDownloadableThumbnailForMedia:a})}d("WALogger").LOG(i());w=d("WATimeUtils").unixTime();r==null?void 0:r.addPoint("get_media_plaintext_start");z=(yield u(c));if(z==null){d("WALogger").ERROR(h());r==null?void 0:r.endFail("missingPlaintext");return d("WAResultOrError").makeError("no-plaintext")}r==null?void 0:r.addPoint("encrypt_and_upload_plaintext_start");return d("WAEncryptAndUploadPlaintext").encryptAndUploadPlaintext({size:g,filename:b,mediaKey:B,mediaKeyTimestamp:w,mediaTypeDetails:e,mediaUploadQplFlow:r,plaintext:z,plaintextHash:c,updateMediaEntry:v,uploadRetrier:y,uploadToken:t,getDownloadableThumbnailForMedia:a})});return r.apply(this,arguments)}function s(a,c,e,f){return function(){var g=b("asyncToGeneratorRuntime").asyncToGenerator(function*(b){if(d("WAGlobals").getConfig().useProtocolMediaKey()){var g;g={directPath:(g=b.directPath)!=null?g:void 0,fbid:(g=b.fbid)!=null?g:void 0,fileEncSha256:b.fileEncSha256,fileSha256:d("WABase64").decodeB64UrlSafe(c),mediaKey:b.mediaKey,mediaKeyTimestamp:b.mediaKeyTimestamp,objectId:(g=b.objectId)!=null?g:void 0,plaintextHash:c,ciphertextHash:d("WAHashUtils").toCiphertextHash(b.fileEncSha256),serverMediaType:b.serverMediaType,sidecar:(g=b.sidecar)!=null?g:void 0,scanLengths:void 0,uploadToken:b.uploadToken,size:void 0};yield d("WABulkPutMediaKeysApi").bulkPutMediaKeys([g])}var h=d("WAMediaUtils").encodeMediaEntryForUpload(b);if(a==null)return f(c,function(){return h},b==null?void 0:b.objectId,b==null?void 0:b.serverMediaType);else return e(c,a,function(){return h},b==null?void 0:b.objectId,b==null?void 0:b.serverMediaType)});function h(a){return g.apply(this,arguments)}return h}()}g.uploadMedia=a}),98);
__d("WAAPIEager",["WAAPIMetrics","WABulkSetRotateSenderKeyToTrueApi","WADbRegistrationApi","WADownloadMedia","WAGenerateAndUploadPreKeys","WAGetCurrentUserDeviceList","WAGetDevices","WANotifyDeviceChange","WAPreEstablishOutgoingSessionForGroup","WAQueryGroups","WARemoveCurrentDevice","WARemoveDevice","WASendAppDataFanoutProtocol","WASendMsgUtilV2","WASendPing","WASyncAbProps","WAUploadMedia"],(function(a,b,c,d,e,f,g){"use strict";a={getCurrentUserDeviceList:function(){return d("WAAPIMetrics").withMetrics(d("WAGetCurrentUserDeviceList").getCurrentUserDeviceList,"getCurrentUserDeviceList")()},syncAbProps:function(){return d("WAAPIMetrics").withMetrics(d("WASyncAbProps").syncAbProps,"syncAbProps").apply(void 0,arguments)},generateAndUploadPreKeys:function(){return d("WAAPIMetrics").withMetrics(d("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys,"generateAndUploadPreKeys").apply(void 0,arguments)},getDevicesBeforeSend:function(){return d("WAAPIMetrics").withMetrics(d("WASendMsgUtilV2").getDevicesBeforeSend,"getDevicesBeforeSend").apply(void 0,arguments)},preEstablishSession:function(){return d("WAAPIMetrics").withMetrics(d("WAPreEstablishOutgoingSessionForGroup").preEstablishSession,"preEstablishSession").apply(void 0,arguments)},sendChatMessage:function(){return d("WAAPIMetrics").withMetrics(d("WASendMsgUtilV2").sendChatMessage,"sendChatMessage").apply(void 0,arguments)},updateClockSkew:function(){return d("WAAPIMetrics").withMetrics(d("WASendPing").updateClockSkew,"updateClockSkew").apply(void 0,arguments)},queryGroups:function(){return d("WAAPIMetrics").withMetrics(d("WAQueryGroups").queryGroups,"queryGroups").apply(void 0,arguments)},getDevices:function(){return d("WAAPIMetrics").withMetrics(d("WAGetDevices").getDevices,"getDevices").apply(void 0,arguments)},removeDevice:function(){return d("WAAPIMetrics").withMetrics(d("WARemoveDevice").removeDevice,"removeDevice").apply(void 0,arguments)},removeCurrentDevice:function(){return d("WAAPIMetrics").withMetrics(d("WARemoveCurrentDevice").removeCurrentDevice,"removeCurrentDevice")()},notifyDeviceChange:function(){return d("WAAPIMetrics").withMetrics(d("WANotifyDeviceChange").notifyDeviceChange,"notifyDeviceChange").apply(void 0,arguments)},saveLastSessionDeviceWasLinkedTo:function(){return d("WAAPIMetrics").withMetrics(d("WADbRegistrationApi").saveLastSessionDeviceWasLinkedTo,"saveLastSessionDeviceWasLinkedTo").apply(void 0,arguments)},sendAppData:function(){return d("WAAPIMetrics").withMetrics(d("WASendAppDataFanoutProtocol").sendAppDataToDevicesProtocol,"sendAppData").apply(void 0,arguments)},setRotateSenderKeyToTrue:function(){return d("WAAPIMetrics").withMetrics(d("WABulkSetRotateSenderKeyToTrueApi").bulkSetRotateSenderKeyToTrue,"setRotateSenderKeyToTrue").apply(void 0,arguments)},uploadMedia:function(a){return d("WAUploadMedia").uploadMedia(a)},downloadMedia:function(a){return d("WADownloadMedia").downloadMedia(a)},cachedDownloadFullMediaOnly:function(a){return d("WADownloadMedia").cachedDownloadFullMediaOnly(a)}};b=a;g["default"]=b}),98);