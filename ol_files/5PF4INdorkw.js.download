;/*FB_PKG_DELIM*/

__d("LSDecryptMessageV2",["LSAppendDataTraceAddon","LSArrayGetObjectAt","LSCreateDerivedKeys.nop","LSGetBlobFromString.nop","LSIsMobileClient","LSLogMebClientEvent.nop","LSSymmetricEncryptionCreateDecryptedString.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessageV2] Beginning execution."),d[1]=c.i64.of_float(Date.now()),d[8]=a[2]==null?c.i64.cast([0,0]):a[2],d[2]=c.i64.of_int32(a[3].length),c.i64.eq(d[2],c.i64.cast([0,1]))?c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[3],c.i64.cast([0,0])).then(function(a){return a=a,d[12]=a[0],d[13]=a[1],a})},function(e){return d[14]=d[12].get("epoch_anon_id"),d[12],d[15]=d[12].get("epoch_root_key"),d[12],d[16]=c.createArray(),d[26]=(d[16].push(c.i64.cast([0,32])),d[16]),c.i64.ge(d[8],c.i64.cast([0,3]))?c.resolve(d[17]=void 0):c.sequence([function(e){return c.nativeOperation(b("LSGetBlobFromString.nop"),a[1]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[17]=d[26]}])},function(e){return c.i64.ge(d[8],c.i64.cast([0,4]))?(d[26]="_",d[18]=["message_key_in_epoch",d[26],c.blobs.to_string(d[14]),d[26],"cipher_version",d[26],c.i64.to_string(d[8]),d[26],"thread",d[26],a[1]==null?"":a[1]].join("")):(c.i64.ge(d[8],c.i64.cast([0,3]))?(d[27]="_",d[26]=["message_key_in_epoch",d[27],c.blobs.to_string(d[14]),d[27],"cipher_version",d[27],c.i64.to_string(d[8]),d[27],"thread",d[27],a[1]==null?"":a[1]].join("")):(c.i64.ge(d[8],c.i64.cast([0,2]))?(d[28]="_",d[27]=["message_key_in_epoch",d[28],c.blobs.to_string(d[14]),d[28],"cipher_version",d[28],c.i64.to_string(d[8])].join("")):d[27]=["message_key_in_epoch","_",c.blobs.to_string(d[14])].join(""),d[26]=d[27]),d[18]=d[26]),c.nativeOperation(b("LSGetBlobFromString.nop"),d[18]).then(function(a){return a=a,d[19]=a[0],a})},function(a){return c.nativeOperation(b("LSCreateDerivedKeys.nop"),d[19],d[17],d[15],d[16]).then(function(a){return a=a,d[20]=a[0],a})},function(a){return d[20]?d[21]=!1:d[21]=!0,d[21]?c.resolve(d[22]=void 0):c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[20],c.i64.cast([0,0])).then(function(a){return a=a,d[26]=a[0],d[27]=a[1],a})},function(a){return d[22]=d[26]}])},function(e){return c.blobs.neq(d[22],void 0)?c.sequence([function(e){return c.nativeOperation(b("LSSymmetricEncryptionCreateDecryptedString.nop"),d[22],c.blobs.of_string(["message_thread","_",a[1]].join("")),a[0]).then(function(a){return a=a,d[26]=a[0],a})},function(a){return d[26]!==void 0?c.resolve(d[27]=d[26]):c.sequence([function(a){return d[28]=["Failed to decrypt message. Epoch Anon ID: ",c.blobs.to_string(d[14]),", Encryption Version: ",c.i64.to_string(d[8])].join(""),function(a){c.logger(a).mustfix(a)}(["[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] ","",d[28]].join("")),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessageV2StoredProcedure",[d[28]].join(""),d[29],c.i64.cast([0,3]))},function(a){return d[27]=void 0}])},function(a){return d[23]=d[27]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] Decryption message key is null"),void 0!==void 0?c.sequence([function(a){return void 0!==void 0?c.storedProcedure(b("LSAppendDataTraceAddon"),void 0,c.i64.cast([0,85]),c.i64.cast([0,2]),"[EncryptedBackups][LSEncryptedBackupsDecryptMessageV2StoredProcedure] Decryption message key is null",void 0):c.resolve()},function(a){return c.storedProcedure(b("LSIsMobileClient")).then(function(a){return a=a,d[27]=a[0],a})},function(a){return d[27]?d[28]=!0:d[28]=!1,d[28]&&!0?(function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBTraceUtils] LSDataTraceMciTraceLog native op not supported"),d[29]=c.createArray(),void 0!==void 0?d[30]=(d[29].push(void 0),d[29]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBTraceUtils","LSDataTraceMciTraceLog native op not supported",d[29],c.i64.cast([0,3]))):c.resolve()}]):c.resolve()},function(a){return d[26]=c.createArray(),void 0!==void 0?d[27]=(d[26].push(void 0),d[26]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"LSEncryptedBackupsDecryptMessageV2StoredProcedure","Decryption message key is null",d[26],c.i64.cast([0,3]))},function(a){return d[23]=void 0}])},function(a){return d[23]!==void 0?(a=[d[23],void 0],d[24]=a[0],d[25]=a[1],a):(d[26]=new c.Map(),d[26].set("error_code",c.i64.cast([0,101])),d[26].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[26].set("error_message",""),a=[void 0,d[26]],d[24]=a[0],d[25]=a[1],a),a=[d[24],d[25]],d[3]=a[0],d[4]=a[1],a}]):c.resolve((d[12]=c.i64.of_int32(a[3].length),c.i64.eq(d[12],c.i64.cast([0,0]))?(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,102])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[15].set("error_message",""),e=[void 0,d[15]],d[13]=e[0],d[14]=e[1],e):(d[15]=new c.Map(),d[15].set("error_code",c.i64.cast([0,103])),d[15].set("stored_procedure","LSEncryptedBackupsDecryptMessageV2StoredProcedure"),d[15].set("error_message",""),e=[void 0,d[15]],d[13]=e[0],d[14]=e[1],e),e=[d[13],d[14]],d[3]=e[0],d[4]=e[1],e))},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[9]="Finishing execution. Execution time: ",d[10]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[11]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessageV2] ",d[7],d[9],d[7],d[10],d[7],d[11]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[12]=",",d[13]=c.createArray(),void 0!==void 0?d[14]=(d[13].push(void 0),d[13]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptMessageV2",[d[9],d[12],d[10],d[12],d[11]].join(""),d[13],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[3],d[4]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDecryptMessageV2StoredProcedure";e.exports=a}),null);
__d("LSDecryptMessages",["LSArrayGetObjectAt","LSBase64Encode.nop","LSCreateDerivedKeys.nop","LSDecryptMessageV2","LSIsEncryptionVersionSecure","LSLogMebClientEvent.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(f){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][decryptMessages] Beginning execution."),d[1]=c.i64.of_float(Date.now()),c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(e,f){var g=e.done;e=e.value;return g?(d[11]=new c.Map(),d[11].set("error_code",c.i64.cast([0,1])),d[11].set("stored_procedure","LSEncryptedBackupsDecryptMessagesStoredProcedure"),d[11].set("error_message",""),g=[void 0,d[11]],d[2]=g[0],d[3]=g[1],g):(f=e.item,c.sequence([function(a){return d[19]=f.backupId,d[20]=f.deviceId,d[18]=f.backupTenancy,d[17]=f.encryptionVersion,d[11]=void 0,c.i64.neq(d[11],void 0)?c.resolve(d[12]=d[11]):c.sequence([function(a){return d[21]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[22]=a[0],a})},function(a){return d[22]?d[31]=(d[21].push(c.i64.cast([0,0])),d[21]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[23]=a[0],a})},function(a){return d[23]?d[31]=(d[21].push(c.i64.cast([0,2])),d[21]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[24]=a[0],a})},function(a){return d[24]?d[31]=(d[21].push(c.i64.cast([0,3])),d[21]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[25]=a[0],a})},function(a){return d[25]?d[31]=(d[21].push(c.i64.cast([0,4])),d[21]):0,d[26]=c.createArray(),d[27]=c.i64.of_int32(d[21].length),c.i64.gt(d[27],c.i64.cast([0,0]))?c.loopAsync(d[27],function(a){return d[31]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[21],d[31]).then(function(a){return a=a,d[32]=a[0],d[33]=a[1],a})},function(a){return d[34]=(d[26].push(d[32]),d[26])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[31]=c.createArray(),d[32]=c.i64.of_int32(d[26].length),c.i64.gt(d[32],c.i64.cast([0,0]))?c.loopAsync(d[32],function(a){return d[34]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[26],d[34]).then(function(a){return a=a,d[35]=a[0],d[36]=a[1],a})},function(a){return d[37]=(d[31].push(c.i64.to_string(d[35])),d[31])}])}):c.resolve()},function(a){return d[33]=d[31].join(","),d[28]=d[33]}])},function(a){return d[26].some(function(a){return c.i64.eq(d[17],a)})?d[29]=d[17]:d[29]=void 0,c.i64.neq(d[29],void 0)?d[30]=d[29]:d[30]=void 0,d[12]=d[30]}])},function(e){return c.i64.neq(d[12],void 0)?d[13]=d[12]:d[13]=c.i64.cast([0,0]),c.i64.neq(d[18],void 0)?d[14]=d[18]:d[14]=c.i64.cast([0,1]),c.i64.neq(d[20],void 0)?c.sequence([function(e){return d[21]=c.createArray(),d[22]=c.createArray(),d[23]=new c.Map(),d[24]=c.i64.of_int32(a[0].length),c.i64.gt(d[24],c.i64.cast([0,0]))?c.loopAsync(d[24],function(e){return d[28]=e,c.sequence([function(e){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),a[0],d[28]).then(function(a){return a=a,d[29]=a[0],d[30]=a[1],a})},function(a){return d[31]=d[29].get("epoch_anon_id"),d[29],d[32]=d[23].get(c.blobs.to_string(d[31])),d[23],d[32]!==void 0?c.resolve(d[33]=d[32]):c.sequence([function(a){return d[38]=d[29].get("epoch_anon_id"),d[29],d[39]=d[29].get("epoch_id"),d[29],c.i64.neq(d[39],void 0)?c.sequence([function(a){return d[42]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[39]]]]),function(a){return c.i64.eq(a.backupId,d[19])&&c.i64.eq(a.epochId,d[39])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[43]=new c.Map(),d[43].set("epoch_root_key",a.epochRootKeyBlob),d[43].set("epoch_anon_id",a.epochAnonIdBlob),d[44]=(d[42].push(d[43]),d[42])})},function(a){return d[40]=d[42]}]):c.sequence([function(a){return d[42]=c.createArray(),c.forEach(c.filter(c.db.table(169).fetch([[[d[19]]],"fk_secure_encrypted_backups_client_state"]),function(a){return c.i64.eq(a.backupId,d[19])&&c.blobs.eq(a.epochAnonIdBlob,d[38])&&c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}),function(a){a=a.item;return d[43]=new c.Map(),d[43].set("epoch_root_key",a.epochRootKeyBlob),d[43].set("epoch_anon_id",a.epochAnonIdBlob),d[44]=(d[42].push(d[43]),d[42])})},function(a){return d[40]=d[42]}])},function(a){return d[41]=c.i64.of_int32(d[40].length),c.i64.gt(d[41],c.i64.cast([0,0]))?(d[42]=d[29].get("epoch_anon_id"),d[29],d[23].set(c.blobs.to_string(d[42]),d[40])):0,d[33]=d[40]}])},function(e){return d[34]=d[29].get("value"),d[29],d[35]=d[29].get("encryption_version"),d[29],c.storedProcedure(b("LSDecryptMessageV2"),d[34],a[1],d[35],d[33]).then(function(a){return a=a,d[36]=a[0],d[37]=a[1],a})},function(a){return d[36]!==void 0?c.resolve((d[38]=d[29].get("otid"),d[29],d[39]=new c.Map(),d[39].set("value",d[36]),d[39].set("otid",d[38]),d[40]=(d[21].push(d[39]),d[21]))):c.sequence([function(a){return d[37]!==void 0?c.sequence([function(a){return d[38]=c.i64.of_int32(d[33].length),c.i64.gt(d[38],c.i64.cast([0,0]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[33],c.i64.cast([0,0])).then(function(a){return a=a,d[49]=a[0],d[50]=a[1],a})},function(a){return d[51]=d[49].get("epoch_root_key"),d[49],d[52]=c.createArray(),d[57]=(d[52].push(c.i64.cast([0,18])),d[52]),c.nativeOperation(b("LSCreateDerivedKeys.nop"),c.blob("bWViL2RlYnVnL2ZpbmdlcnByaW50L01FQkVwb2NoUm9vdEtleQ=="),void 0,d[51],d[52]).then(function(a){return a=a,d[53]=a[0],a})},function(a){return d[53]!==void 0?c.sequence([function(a){return d[57]=c.i64.of_int32(d[53].length),c.i64.ge(d[57],c.i64.cast([0,1]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[53],c.i64.cast([0,0])).then(function(a){return a=a,d[59]=a[0],d[60]=a[1],a})},function(a){return d[58]=d[59]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM."),d[59]=c.createArray(),void 0!==void 0?d[60]=(d[59].push(void 0),d[59]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint","CreateDerivedKeys returned an empty list of keys. This should never happen; aborting dasm VM.",d[59],c.i64.cast([0,3]))},function(a){return d[58]=void 0}])},function(a){return d[54]=d[58]}]):c.sequence([function(a){return function(a){c.logger(a).mustfix(a)}("[EncryptedBackups][MEBFingerprint] CreateDerivedKeys returned null. This should never happen; aborting dasm VM."),d[57]=c.createArray(),void 0!==void 0?d[58]=(d[57].push(void 0),d[57]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"MEBFingerprint","CreateDerivedKeys returned null. This should never happen; aborting dasm VM.",d[57],c.i64.cast([0,3]))},function(a){return d[54]=void 0}])},function(a){return c.blobs.neq(d[54],void 0)?d[55]=!0:d[55]=!1,d[55]?0:(function(a){c.logger(a).mustfix(a)}("LS::assert is failed. Attempting to coerce a null value to nonnull."),c["throw"]("LS::assert is failed. Attempting to coerce a null value to nonnull.")),c.blobs.neq(d[54],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[54]).then(function(a){return a=a,d[57]=a[0],a})},function(a){return d[56]=d[57]==null?"[encodingFailed]":d[57]}]):c.resolve(d[56]="[null]")},function(a){return d[39]=d[56]}]):c.resolve(d[39]="[noEpochs]")},function(a){return d[40]=d[29].get("otid"),d[29],d[41]=d[29].get("epoch_anon_id"),d[29],d[42]=d[29].get("encryption_version"),d[29],c.i64.neq(d[42],void 0)?d[43]=c.i64.to_string(d[42]):d[43]="null",d[44]=c.i64.of_int32(d[33].length),d[45]=d[29].get("epoch_fingerprint"),d[29],c.blobs.neq(d[45],void 0)?c.sequence([function(a){return c.nativeOperation(b("LSBase64Encode.nop"),d[45]).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[46]=d[49]==null?"[encodingFailed]":d[49]}]):c.resolve(d[46]="[null]")},function(a){return d[47]=d[29].get("backup_id"),d[29],d[48]="",d[37].set("error_message",["Decryption failed for message with otid:",d[48],d[40],d[48]," epoch:",d[48],c.blobs.to_string(d[41]),d[48]," version:",d[48],d[43],d[48]," epoch_key_count:",d[48],c.i64.to_string(d[44]),d[48]," vsr_fingerprint:",d[48],d[46],d[48]," local_fingerprint:",d[48],d[39],d[48]," vsr_backup_id:",d[48],c.i64.to_string(d[47])==null?"[null]":c.i64.to_string(d[47]),d[48]," local_backup_id:",d[48],c.i64.to_string(d[19]),d[48]," local_device_id:",d[48],c.i64.to_string(d[20])].join(""))}]):c.resolve()},function(a){return d[38]=(d[22].push(d[37]),d[22])}])}])}):c.resolve()},function(a){return d[25]=c.i64.of_int32(d[22].length),c.i64.gt(d[25],c.i64.cast([0,0]))?c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[22],c.i64.cast([0,0])).then(function(a){return a=a,d[28]=a[0],d[29]=a[1],a})},function(a){return a=[void 0,d[28]],d[26]=a[0],d[27]=a[1],a}]):c.resolve((a=[d[21],void 0],d[26]=a[0],d[27]=a[1],a))},function(a){return a=[d[26],d[27]],d[15]=a[0],d[16]=a[1],a}]):c.resolve((d[21]=new c.Map(),d[21].set("error_code",c.i64.cast([0,24])),d[21].set("stored_procedure","LSEncryptedBackupsDecryptMessagesStoredProcedure"),d[21].set("error_message",""),e=[void 0,d[21]],d[15]=e[0],d[16]=e[1],e))},function(a){return a=[d[15],d[16]],d[2]=a[0],d[3]=a[1],a}]))})},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][decryptMessages] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"decryptMessages",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(a){return a=[d[2],d[3]],e[0]=a[0],e[1]=a[1],a}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsDecryptMessagesStoredProcedure";e.exports=a}),null);
__d("MAWRestoreMessagesFromEncryptedBackupsDeferred",["ExecutionEnvironment","LSDatabaseSingleton","LSVec","MAWEncryptedBackupUtils","Promise","asyncToGeneratorRuntime","cr:10036","gkx","promiseDone","requireDeferred"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j,k=c("requireDeferred")("MAWRestoreMessagesFromEncryptedBackupsNOP").__setRef("MAWRestoreMessagesFromEncryptedBackupsDeferred");function a(a,e,f,g,l,m,n,o,p,q,r,s){return k.load().then(function(){var k=b("asyncToGeneratorRuntime").asyncToGenerator(function*(k){var t=q!=null?Number(q):void 0;t=c("gkx")("201")?d("MAWEncryptedBackupUtils").getMessageMetadataFromDeanonAPI(e,f.length,t):(j||(j=b("Promise"))).resolve();var u,v;(i||(i=c("ExecutionEnvironment"))).isInWorker&&b("cr:10036")!=null?(yield b("cr:10036").init(),u=(yield b("cr:10036").getLSStorage())):(u=(yield (h||(h=d("LSDatabaseSingleton"))).LSDatabaseSingleton),v=(yield t));c("promiseDone")(u.runInTransaction(function(b){return k.call(b,a,e,f,g,l,m,n,o,p,q,r,v,s)},"readwrite"));return[c("LSVec").ofArray([]),c("LSVec").ofArray([]),!1]});return function(a){return k.apply(this,arguments)}}())}g.call=a}),98);
__d("LSRestoreEchoBlobs.nop",["CurrentUser","EchoMessage","I64","LSIntEnum","LSMEBTaskCreationSource","LSVec","MAWAsyncEBPendingQueryPromise","MAWEBRestoreTrackingUtils","MAWEncryptedBackupUtils","MAWEncryptedBackupsDYIHandleMessageRestore","MAWHandleEBRestoreWithHIM","MAWJids","MAWJobDefinitions","MAWRestoreMessagesFromEncryptedBackupsDeferred","Promise","WAJids","WALogger","WATagsLogger","gkx","promiseDone"],(function(a,b,c,d,e,f,g){"use strict";var h,i,j;function k(){var a=babelHelpers.taggedTemplateLiteralLoose(["LSRestoreEchoBlobs error: ",""]);k=function(){return a};return a}function l(){var a=babelHelpers.taggedTemplateLiteralLoose(["LSRestoreEchoBlobs error: ",""]);l=function(){return a};return a}function m(){var a=babelHelpers.taggedTemplateLiteralLoose(["Restoring Messenger DYI batch"]);m=function(){return a};return a}function n(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreEchoBlobs - no messages returned but hasMoreBefore is true"]);n=function(){return a};return a}function o(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreEchoBlobs - Failed to decode echo message, with error: ",""]);o=function(){return a};return a}function p(){var a=babelHelpers.taggedTemplateLiteralLoose(["restoreEchoBlobs - "," "," ",""]);p=function(){return a};return a}a=function(a,e,f,g,q,r,s,t,u,v,w,x,y){try{if(w!=null){d("WATagsLogger").TAGS(["labyrinth_web","echo_restore",(a=w)!=null?a:"no_request_id"]).LOG(p(),w,v,(e=x)!=null?e:"");d("MAWEBRestoreTrackingUtils").markEBRestoreEcho(y);f=c("LSVec").toArray(g);d("MAWEBRestoreTrackingUtils").addQPLRestorePoint({pointName:"native_op_start",traceId:w,type:"echo"});d("MAWAsyncEBPendingQueryPromise").resolvePendingQueryIfPresent(w,{echoMessages:f.map(d("MAWJobDefinitions").toEncodedEchoMessage),hasMoreAfter:s,hasMoreBefore:q,isPointQuery:u,messages:f.map(function(a){try{a=d("EchoMessage").decodeEchoMessage(a);if(a==null)return null;var b=d("MAWJids").toUserJid(c("CurrentUser").getAccountID());b=d("MAWHandleEBRestoreWithHIM").convertEchoMessage(a,d("WAJids").unsafeCoerceToChatJid("threadId"+d("WAJids").MSGR_USER_DOMAIN),b);if(b==null||b.length===0)return null;b=(b=b[0].decodedMsg)==null?void 0:b.unstoredDbMsg;if(b==null)return null;b.sortOrderMs=a.sortOrderMs;return b}catch(b){d("WATagsLogger").TAGS(["labyrinth_web","echo_restore",(a=w)!=null?a:"no_request_id"]).ERROR(o(),b.message);return null}}).filter(Boolean),nextMessageTimestampMsBefore:r,referenceTimestamp:x,requestId:w,restoreType:"echo",threadId:v})}a=c("LSVec").toArray(g);d("MAWEncryptedBackupUtils").logIfDuplicateMessagesFoundInRestore(a,"echo_restore");if(q===!0&&a.length===0){d("WATagsLogger").TAGS(["labyrinth_web","echo_restore",(e=w)!=null?e:"no_request_id"]).ERROR(n())}f=y!=null&&(j||(j=d("LSIntEnum"))).toNumber(y)===c("LSMEBTaskCreationSource").BULK_QUERY_FOR_SEARCH_RESULT;if(f)return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])]);g=y!=null&&(j||(j=d("LSIntEnum"))).toNumber(y)===c("LSMEBTaskCreationSource").FTS_INDEX_EB_MESSAGES_WEB;if(g)return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])]);e=y!=null&&(j||(j=d("LSIntEnum"))).toNumber(y)===c("LSMEBTaskCreationSource").MSGR_DYI;f=c("gkx")("3057");if(e&&f){d("WATagsLogger").TAGS(["labyrinth_web","echo_restore",(g=w)!=null?g:"no_request_id"]).LOG(m());e=a.map(d("EchoMessage").decodeEchoMessage).filter(Boolean);void d("MAWEncryptedBackupsDYIHandleMessageRestore").handleMAWEchoMessageRangeQueryRestore(v,e,q,r);return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])])}c("promiseDone")(d("MAWRestoreMessagesFromEncryptedBackupsDeferred").call("AdvancedCrypto",d("MAWJobDefinitions").toThreadJidPrimaryId(v),a.map(d("MAWJobDefinitions").toEncodedEchoMessage),q,r==null?void 0:(i||(i=d("I64"))).to_int32(r),s,t==null?void 0:(i||(i=d("I64"))).to_int32(t),u,w,x,y!=null?(j||(j=d("LSIntEnum"))).unwrapIntEnum(y):-1)["catch"](function(a){d("WALogger").ERROR(l(),a)}));return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])])}catch(a){d("WALogger").ERROR(k(),a);w!=null&&d("MAWAsyncEBPendingQueryPromise").rejectPendingQueryIfPresent(w,a);return(h||(h=b("Promise"))).resolve([!0,c("LSVec").ofArray([]),c("LSVec").ofArray([])])}};g["default"]=a}),98);
__d("LSHandleMessageRestoreResponse",["LSArrayGetObjectAt","LSDecryptMessages","LSDeleteBackupOnClient","LSIsEncryptionVersionSecure","LSIssueNewEbTaskAndGetTaskIDV2","LSIssuePointQueryRestoreTask","LSLoadThreadPkFromThreadId","LSLogMebClientEvent.nop","LSLogWebQpl.nop","LSRestoreEchoBlobs.nop"],(function(a,b,c,d,e,f){function a(){var a=arguments,c=a[a.length-1],d=[],e=[];return c.sequence([function(e){return c.sequence([function(e){return d[0]=c.i64.of_float(Date.now()),function(a){c.logger(a).info(a)}("[EncryptedBackups][handleMessageRestoreResponse] Beginning execution."),d[1]=c.i64.of_float(Date.now()),a[7]?(d[11]="handleMessageRestoreResponse was called with instructions to delete the user's EB client state",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[11]].join("")),d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[11]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()},function(e){return d[2]=a[5].get("request_id"),a[5],d[3]=c.i64.of_int32(a[0].length),d[2]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[2],c.i64.cast([0,521476165]),"call_from_client",d[3],void 0,void 0):c.resolve()},function(b){return c.i64.neq(a[6],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[11]=!1:(e=b.item,d[14]=e.deviceId,c.i64.neq(d[14],void 0)?d[13]=c.i64.neq(d[14],a[6]):d[13]=!1,d[11]=d[13])})},function(a){return d[4]=d[11]}]):c.resolve(d[4]=!1)},function(e){return d[4]?(d[11]="Exiting early due to EBDevice ID mismatch",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[11]].join("")),d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[11]].join(""),d[12],c.i64.cast([0,4]))):c.sequence([function(b){return d[11]=a[5].get("reference_timestamp"),a[5],d[12]=a[5].get("request_id"),a[5],d[13]=a[5].get("restore_task_source"),a[5],c.i64.neq(a[6],void 0)?c.sequence([function(b){return c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))}).next().then(function(b,e){var f=b.done;b=b.value;return f?d[20]=!1:(e=b.item,d[23]=e.deviceId,c.i64.neq(d[23],void 0)?d[22]=c.i64.neq(d[23],a[6]):d[22]=!1,d[20]=d[22])})},function(a){return d[14]=d[20]}]):c.resolve(d[14]=!1)},function(e){return d[14]?c.resolve((d[20]=new c.Map(),d[20].set("error_code",c.i64.cast([0,110])),d[20].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[20].set("error_message",""),d[15]=d[20])):c.sequence([function(e){return d[20]=c.i64.of_int32(a[0].length),d[12]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[12],c.i64.cast([0,521476165]),"decryption_start",d[20],d[13],void 0):c.resolve()},function(e){return c.storedProcedure(b("LSDecryptMessages"),a[0],a[2]).then(function(a){return a=a,d[21]=a[0],d[22]=a[1],a})},function(e){return d[21]!==void 0?c.sequence([function(e){return c.storedProcedure(b("LSLoadThreadPkFromThreadId"),a[2]).then(function(a){return a=a,d[24]=a[0],d[25]=a[1],a})},function(e){return c.i64.neq(d[24],void 0)?c.sequence([function(e){return d[27]=c.i64.of_int32(a[0].length),d[12]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[12],c.i64.cast([0,521476165]),"decryption_success",d[27],d[13],void 0):c.resolve()},function(e){return void 0!==void 0?c.resolve(d[28]=void 0):c.sequence([function(a){return d[29]=c.createArray(),d[30]=c.i64.of_int32(d[21].length),c.i64.gt(d[30],c.i64.cast([0,0]))?c.loopAsync(d[30],function(a){return d[39]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[21],d[39]).then(function(a){return a=a,d[40]=a[0],d[41]=a[1],a})},function(a){return d[42]=d[40].get("value"),d[40],d[43]=(d[29].push(d[42]),d[29])}])}):c.resolve()},function(e){return d[31]=a[1].get("has_more_before"),a[1],d[32]=a[1].get("next_message_timestamp_ms_before"),a[1],d[33]=a[1].get("has_more_after"),a[1],d[34]=a[1].get("next_message_timestamp_ms_after"),a[1],c.nativeOperation(b("LSRestoreEchoBlobs.nop"),d[24],d[29],d[31],d[32],d[33],d[34],a[4],a[2],d[12],d[11],d[13]).then(function(a){return a=a,d[35]=a[0],d[36]=a[1],d[37]=a[2],a})},function(e){return a[7]?c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,void 0,!0,d[12],void 0,!0):c.resolve()},function(e){return d[35]?c.sequence([function(e){return d[39]=c.i64.of_int32(d[37].length),d[40]=c.i64.of_int32(d[36].length),c.i64.eq(d[40],d[39])?c.sequence([function(e){return d[42]=c.i64.cast([0,0]),d[43]=c.i64.of_int32(d[37].length),c.i64.gt(d[43],c.i64.cast([0,0]))?c.loopAsync(d[43],function(e){return d[44]=e,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[37],d[44]).then(function(a){return a=a,d[45]=a[0],d[46]=a[1],a})},function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[36],d[42]).then(function(a){return a=a,d[47]=a[0],d[48]=a[1],a})},function(e){return c.storedProcedure(b("LSIssuePointQueryRestoreTask"),a[2],d[47],d[45],void 0,c.i64.cast([0,35])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[42]=c.i64.add(d[42],c.i64.cast([0,1]))}])}):c.resolve()},function(a){return d[41]=void 0}]):c.resolve((d[42]=new c.Map(),d[42].set("error_code",c.i64.cast([0,106])),d[42].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[42].set("error_message",""),d[41]=d[42]))},function(a){return d[38]=void 0}]):c.resolve((d[39]=new c.Map(),d[39].set("error_code",c.i64.cast([0,105])),d[39].set("stored_procedure","LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure"),d[39].set("error_message",""),d[38]=d[39]))},function(a){return d[28]=d[38]}])},function(a){return d[26]=d[28]}]):c.resolve(d[26]=d[25])},function(a){return d[23]=d[26]}]):c.resolve((d[22]!==void 0?(d[24]=d[22].get("error_code"),d[22],c.i64.eq(d[24],c.i64.cast([0,1]))?0:0):0,d[23]=d[22]))},function(a){return d[15]=d[23]}])},function(e){return d[15]!==void 0?c.sequence([function(e){return d[20]=c.i64.of_int32(a[0].length),d[12]!==void 0?c.nativeOperation(b("LSLogWebQpl.nop"),d[12],c.i64.cast([0,521476165]),"decryption_fail",d[20],d[13],!1):c.resolve()},function(e){return a[7]?c.storedProcedure(b("LSDeleteBackupOnClient"),void 0,void 0,!0,d[12],void 0,!0):c.resolve()},function(e){return d[21]=d[15].get("error_code"),d[15],d[22]=d[15].get("stored_procedure"),d[15],d[23]=a[5].get("restore_operation_type"),a[5],d[24]=d[15].get("error_message"),d[15],c.islc(c.filter(c.db.table(168).fetch(),function(a){return c.i64.eq(a.authorityLevel,c.i64.cast([0,80]))||!1}),0,c.i64.to_float(c.i64.cast([0,1]))).next().then(function(a,e){var f=a.done;a=a.value;return f?d[25]=void 0:(e=a.item,c.sequence([function(a){return d[45]=e.deviceId,d[44]=e.backupTenancy,d[43]=e.encryptionVersion,d[38]=void 0,c.i64.neq(d[38],void 0)?c.resolve(d[39]=d[38]):c.sequence([function(a){return d[46]=c.createArray(),c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,0])).then(function(a){return a=a,d[47]=a[0],a})},function(a){return d[47]?d[56]=(d[46].push(c.i64.cast([0,0])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,2])).then(function(a){return a=a,d[48]=a[0],a})},function(a){return d[48]?d[56]=(d[46].push(c.i64.cast([0,2])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,3])).then(function(a){return a=a,d[49]=a[0],a})},function(a){return d[49]?d[56]=(d[46].push(c.i64.cast([0,3])),d[46]):0,c.storedProcedure(b("LSIsEncryptionVersionSecure"),c.i64.cast([0,4])).then(function(a){return a=a,d[50]=a[0],a})},function(a){return d[50]?d[56]=(d[46].push(c.i64.cast([0,4])),d[46]):0,d[51]=c.createArray(),d[52]=c.i64.of_int32(d[46].length),c.i64.gt(d[52],c.i64.cast([0,0]))?c.loopAsync(d[52],function(a){return d[56]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[46],d[56]).then(function(a){return a=a,d[57]=a[0],d[58]=a[1],a})},function(a){return d[59]=(d[51].push(d[57]),d[51])}])}):c.resolve()},function(a){return c.sequence([function(a){return d[56]=c.createArray(),d[57]=c.i64.of_int32(d[51].length),c.i64.gt(d[57],c.i64.cast([0,0]))?c.loopAsync(d[57],function(a){return d[59]=a,c.sequence([function(a){return c.nativeTypeOperation("Array",b("LSArrayGetObjectAt"),d[51],d[59]).then(function(a){return a=a,d[60]=a[0],d[61]=a[1],a})},function(a){return d[62]=(d[56].push(c.i64.to_string(d[60])),d[56])}])}):c.resolve()},function(a){return d[58]=d[56].join(","),d[53]=d[58]}])},function(a){return d[51].some(function(a){return c.i64.eq(d[43],a)})?d[54]=d[43]:d[54]=void 0,c.i64.neq(d[54],void 0)?d[55]=d[54]:d[55]=void 0,d[39]=d[55]}])},function(a){return c.i64.neq(d[39],void 0)?d[40]=d[39]:d[40]=c.i64.cast([0,0]),c.i64.neq(d[44],void 0)?d[41]=d[44]:d[41]=c.i64.cast([0,1]),c.i64.neq(d[45],void 0)?d[42]=d[45]:d[42]=void 0,d[25]=d[42]}]))})},function(e){return d[27]=new c.Map(),d[27].set("error_code",d[21]),d[27].set("error_message",d[24]==null?"":d[24]),d[27].set("stored_procedure",d[22]),d[28]=new c.Map(),d[28].set("act_thread_id",a[2]),d[28].set("source",d[13]),d[28].set("restore_operation_type",d[23]),d[28].set("request_id",d[12]),d[28].set("device_id",d[25]),d[29]=new c.Map(),d[29].set("restore_context",d[28]),d[29].set("failure",d[27]),d[30]=d[29].get("restore_context"),d[29],d[31]=d[30].get("act_thread_id"),d[30],d[32]=c.toJSON(d[29]),c.storedProcedure(b("LSIssueNewEbTaskAndGetTaskIDV2"),["encrypted_backups_restore",":",d[31]].join(""),c.i64.cast([0,50030]),d[32],c.i64.cast([0,0]),c.i64.cast([0,93]),c.i64.cast([0,0]),void 0,c.i64.cast([0,0])).then(function(a){return a=a,d[33]=a[0],a})},function(b){return d[34]=a[5].get("restore_operation_type"),a[5],d[35]=d[15].get("error_code"),d[15],d[36]=d[15].get("error_code"),d[15],d[37]=" ",d[16]=["Failed (",d[37],c.i64.to_string(d[36]),d[37],")"].join("")}]):c.resolve((d[20]=a[5].get("restore_operation_type"),a[5],d[16]="Succeeded"))},function(e){return d[17]="",d[18]=["Message Restore Status: ",d[17],d[16],d[17],". ACT Thread ID: ",d[17],a[2]].join(""),function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ","",d[18]].join("")),d[19]=c.createArray(),void 0!==void 0?d[20]=(d[19].push(void 0),d[19]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[18]].join(""),d[19],c.i64.cast([0,4]))}])},function(a){return d[5]=c.i64.of_float(Date.now()),d[6]=c.i64.random(),d[8]="Finishing execution. Execution time: ",d[9]=c.i64.to_string(c.i64.sub(d[5],d[0])),d[10]=" ms",d[7]="",function(a){c.logger(a).info(a)}(["[EncryptedBackups][handleMessageRestoreResponse] ",d[7],d[8],d[7],d[9],d[7],d[10]].join("")),c.i64.eq(c.i64.mod_(d[6],c.i64.cast([0,1e3])),c.i64.cast([0,0]))?(d[11]=",",d[12]=c.createArray(),void 0!==void 0?d[13]=(d[12].push(void 0),d[12]):0,c.nativeOperation(b("LSLogMebClientEvent.nop"),"handleMessageRestoreResponse",[d[8],d[11],d[9],d[11],d[10]].join(""),d[12],c.i64.cast([0,4]))):c.resolve()}])},function(a){return c.resolve(e)}])}a.__sproc_name__="LSEncryptedBackupsHandleMessageRestoreResponseStoredProcedure";e.exports=a}),null);